<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"manual"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="内容[TOC]">
<meta property="og:type" content="article">
<meta property="og:title" content="网络编程03">
<meta property="og:url" content="http://example.com/2023/05/29/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B03/index.html">
<meta property="og:site_name" content="心梦">
<meta property="og:description" content="内容[TOC]">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-05-29T10:15:30.000Z">
<meta property="article:modified_time" content="2023-06-06T13:54:36.711Z">
<meta property="article:author" content="心梦">
<meta property="article:tag" content="网络编程">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/2023/05/29/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B03/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>网络编程03 | 心梦</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="心梦" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">心梦</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-resources">

    <a href="/resources/" rel="section"><i class="download fa-fw"></i>资源</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    

  <a href="https://github.com/heartdream520" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/05/29/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B03/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ailulu.jpg">
      <meta itemprop="name" content="心梦">
      <meta itemprop="description" content="heart_dream">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="心梦">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          网络编程03
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-05-29 18:15:30" itemprop="dateCreated datePublished" datetime="2023-05-29T18:15:30+08:00">2023-05-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-06-06 21:54:36" itemprop="dateModified" datetime="2023-06-06T21:54:36+08:00">2023-06-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BD%91%E7%BB%9C/" itemprop="url" rel="index"><span itemprop="name">网络</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>79k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1:12</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="内容"><a href="#内容" class="headerlink" title="内容"></a>内容</h1><p>[TOC]</p>
<span id="more"></span>

<h1 id="UDP通信"><a href="#UDP通信" class="headerlink" title="UDP通信"></a>UDP通信</h1><p>UDP通信不会自动进行黏包操作</p>
<p>UDP当发送的信息不超过MTU时，将不会进行自动分包操作</p>
<p>互联网情况下MTU：548字节以内</p>
<p>局域网环境下MTU：1472字节以内</p>
<p>要手动分包需要在UDP通信要解决UDP通信的丢包和无序的问题</p>
<h2 id="简单通信代码"><a href="#简单通信代码" class="headerlink" title="简单通信代码"></a>简单通信代码</h2><h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Net.Sockets;</span><br><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UDPSocket</span> : <span class="title">SingletonMonoBehaviour</span>&lt;<span class="title">UDPSocket</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.Awake();</span><br><span class="line">        Socket socket = <span class="keyword">new</span> Socket(AddressFamily.InterNetwork, SocketType.Dgram, ProtocolType.Udp);</span><br><span class="line">        IPAddress ip = IPAddress.Parse(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        IPEndPoint iPEndPoint = <span class="keyword">new</span> IPEndPoint(ip, <span class="number">8080</span>);</span><br><span class="line">        socket.Bind(iPEndPoint);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        IPEndPoint serverEndPoint = <span class="keyword">new</span> IPEndPoint(ip, <span class="number">8081</span>);</span><br><span class="line">        EndPoint endPoint = serverEndPoint <span class="keyword">as</span> EndPoint;</span><br><span class="line">        socket.SendTo(Encoding.UTF8.GetBytes(<span class="string">&quot;客户端发来的&quot;</span>), endPoint);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">byte</span>[] receive_Bytes = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">512</span>];</span><br><span class="line">        <span class="built_in">int</span> receive_Len = socket.ReceiveFrom(receive_Bytes, <span class="keyword">ref</span> endPoint);</span><br><span class="line"></span><br><span class="line">       Debug.Log(<span class="string">$&quot;收到服务端：<span class="subst">&#123;(endPoint <span class="keyword">as</span> IPEndPoint).Address&#125;</span> &quot;</span> +</span><br><span class="line">            <span class="string">$&quot;<span class="subst">&#123;(endPoint <span class="keyword">as</span> IPEndPoint).Port&#125;</span> 的信息：&quot;</span> +</span><br><span class="line">            <span class="string">$&quot;<span class="subst">&#123;Encoding.UTF8.GetString(receive_Bytes, <span class="number">0</span>, receive_Len)&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">using</span> System.Net.Sockets;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Socket socket=<span class="keyword">new</span> Socket(AddressFamily.InterNetwork, SocketType.Dgram, ProtocolType.Udp);</span><br><span class="line">        IPAddress ip = IPAddress.Parse(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">        IPEndPoint iPEndPoint = <span class="keyword">new</span> IPEndPoint(ip, <span class="number">8081</span>);</span><br><span class="line">        socket.Bind(iPEndPoint);</span><br><span class="line">        IPEndPoint clientEndPoint = <span class="keyword">new</span> IPEndPoint(ip, <span class="number">8080</span>);</span><br><span class="line">        EndPoint endPoint= clientEndPoint <span class="keyword">as</span> EndPoint;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">byte</span>[] receive_Bytes = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">512</span>];</span><br><span class="line">        <span class="built_in">int</span> receive_Len= socket.ReceiveFrom(receive_Bytes, <span class="keyword">ref</span> endPoint);</span><br><span class="line"></span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;收到客户端：<span class="subst">&#123;(endPoint <span class="keyword">as</span> IPEndPoint).Address&#125;</span> &quot;</span> +</span><br><span class="line">            <span class="string">$&quot;<span class="subst">&#123;(endPoint <span class="keyword">as</span> IPEndPoint).Port&#125;</span> 的信息：&quot;</span> +</span><br><span class="line">            <span class="string">$&quot;<span class="subst">&#123;Encoding.UTF8.GetString(receive_Bytes,<span class="number">0</span>, receive_Len)&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">        socket.SendTo(Encoding.UTF8.GetBytes(<span class="string">&quot;服务端发来的&quot;</span>), endPoint);</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;发送成功&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="类区分"><a href="#类区分" class="headerlink" title="类区分"></a>类区分</h2><h3 id="服务端-1"><a href="#服务端-1" class="headerlink" title="服务端"></a>服务端</h3><p>服务端需要解决的问题：</p>
<p>区分消息类型，接收多个客户端信息，主动给客户端发送信息，记录上一次收到信息的时间并超时主动移除客户端</p>
<h4 id="ServerSocket"><a href="#ServerSocket" class="headerlink" title="ServerSocket"></a>ServerSocket</h4><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">using</span> System.Net.Sockets;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">ServerSocket</span> : <span class="title">Singleton</span>&lt;<span class="title">ServerSocket</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> Socket serverSocket;</span><br><span class="line">    IPEndPoint serverEndPoint;</span><br><span class="line">    Dictionary&lt;<span class="built_in">string</span>, ClientSocket&gt; clientSocketDir = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, ClientSocket&gt;();</span><br><span class="line">    List&lt;ClientSocket&gt; deleteSocketList=<span class="keyword">new</span> List&lt;ClientSocket&gt;();</span><br><span class="line">    <span class="built_in">bool</span> isConnect = <span class="literal">false</span>;</span><br><span class="line">    <span class="built_in">byte</span>[] receiveBytes = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">512</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">long</span> ClientOutTime = <span class="number">20</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Start</span>(<span class="params"><span class="built_in">string</span> ip, <span class="built_in">int</span> port</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>.serverEndPoint = <span class="keyword">new</span> IPEndPoint(IPAddress.Parse(ip), port);</span><br><span class="line">        serverSocket = <span class="keyword">new</span> Socket(AddressFamily.InterNetwork, SocketType.Dgram, ProtocolType.Udp);</span><br><span class="line">        serverSocket.Bind(serverEndPoint);</span><br><span class="line">        isConnect = <span class="literal">true</span>;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;服务端启动成功，等待客户端连入&quot;</span>);</span><br><span class="line">        ThreadPool.QueueUserWorkItem(<span class="keyword">this</span>.Receive);</span><br><span class="line">        ThreadPool.QueueUserWorkItem(<span class="keyword">this</span>.HandleDeleteClient);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">async</span> <span class="keyword">void</span> <span class="title">HandleDeleteClient</span>(<span class="params"><span class="built_in">object</span>? state</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">long</span> nowTime = Time.Instance.Now_Time;</span><br><span class="line">            <span class="keyword">foreach</span>(<span class="keyword">var</span> c <span class="keyword">in</span> <span class="keyword">this</span>.clientSocketDir.Values)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;检查客户端：<span class="subst">&#123;c.ipPort&#125;</span>  nowTime:<span class="subst">&#123;nowTime&#125;</span> frontMsgTime:<span class="subst">&#123;c.frontMsgTime&#125;</span> &quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (nowTime-c.frontMsgTime &gt;ClientOutTime)</span><br><span class="line">                &#123;</span><br><span class="line">                    AddTodeleteSocketList(c);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">foreach</span>(<span class="keyword">var</span> c <span class="keyword">in</span> <span class="keyword">this</span>.deleteSocketList)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="keyword">this</span>.clientSocketDir.ContainsKey(c.ipPort))</span><br><span class="line">                &#123;</span><br><span class="line">                    clientSocketDir.Remove(c.ipPort);</span><br><span class="line">                    Console.WriteLine(<span class="string">$&quot;客户端：<span class="subst">&#123;c.ipPort&#125;</span>  被移除字典&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            deleteSocketList.Clear();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">await</span> Task.Delay(<span class="number">5000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddTodeleteSocketList</span>(<span class="params">ClientSocket socket</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.deleteSocketList.Contains(socket))</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;客户端：<span class="subst">&#123;socket.ipPort&#125;</span>  被加入删除队列&quot;</span>);</span><br><span class="line">            <span class="keyword">this</span>.deleteSocketList.Add(socket);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Receive</span>(<span class="params"><span class="built_in">object</span>? state</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span> (isConnect)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (serverSocket.Available &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                EndPoint clientEndPoint = <span class="keyword">new</span> IPEndPoint(IPAddress.Any, <span class="number">0</span>);</span><br><span class="line">                <span class="built_in">int</span> receiveLen = serverSocket.ReceiveFrom(receiveBytes, SocketFlags.None, <span class="keyword">ref</span> clientEndPoint);</span><br><span class="line">                <span class="built_in">string</span> ipPort = <span class="string">&quot;&quot;</span>;</span><br><span class="line">                <span class="built_in">string</span> ip;</span><br><span class="line">                <span class="built_in">int</span> port;</span><br><span class="line">                ip = (clientEndPoint <span class="keyword">as</span> IPEndPoint).Address.ToString();</span><br><span class="line">                port = (clientEndPoint <span class="keyword">as</span> IPEndPoint).Port;</span><br><span class="line">                ipPort = ip + port;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">this</span>.clientSocketDir.ContainsKey(ipPort))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">this</span>.clientSocketDir[ipPort] = <span class="keyword">new</span> ClientSocket(ip, port);</span><br><span class="line">                &#125;</span><br><span class="line">                clientSocketDir[ipPort].receive(receiveBytes, receiveLen);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SendToAllClient</span>(<span class="params">BaseMsg msg</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (isConnect)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> x <span class="keyword">in</span> <span class="keyword">this</span>.clientSocketDir.Values)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.deleteSocketList.Contains(x)) <span class="keyword">continue</span>;</span><br><span class="line">                x.SendMsg(msg.Writeing());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Close</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (serverSocket != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            serverSocket.Shutdown(SocketShutdown.Both);</span><br><span class="line">            serverSocket.Close();</span><br><span class="line">            isConnect = <span class="literal">false</span>;</span><br><span class="line">            serverSocket = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ClientSocket"><a href="#ClientSocket" class="headerlink" title="ClientSocket"></a>ClientSocket</h4><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.ComponentModel;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ClientSocket</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> IPEndPoint IPEndPoint;</span><br><span class="line">    <span class="built_in">byte</span>[] receiveBytes=<span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">512</span>];</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">bool</span> isConnected = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> ipPort;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> IsConnected</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!isConnected) Console.WriteLine(<span class="string">$&quot;客户端：<span class="subst">&#123;IPEndPoint&#125;</span>连接已断开&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> isConnected; </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            isConnected = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">long</span> frontMsgTime;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ClientSocket</span>(<span class="params"><span class="built_in">string</span> ip,<span class="built_in">int</span> port</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        IPEndPoint=<span class="keyword">new</span> IPEndPoint(IPAddress.Parse(ip),port);</span><br><span class="line">        ipPort = ip + port;</span><br><span class="line">        IsConnected = <span class="literal">true</span>;</span><br><span class="line">        frontMsgTime = Time.Instance.Now_Time;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">internal</span> <span class="keyword">void</span> <span class="title">receive</span>(<span class="params"><span class="built_in">byte</span>[] receiveBytes, <span class="built_in">int</span> receiveLen</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        frontMsgTime = Time.Instance.Now_Time;</span><br><span class="line">        Array.Copy(receiveBytes, <span class="number">0</span>, <span class="keyword">this</span>.receiveBytes, <span class="number">0</span>, receiveLen);</span><br><span class="line">        ThreadPool.QueueUserWorkItem(HandleReceive);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">HandleReceive</span>(<span class="params"><span class="built_in">object</span>? obj</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(IsConnected)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">int</span> index = <span class="number">0</span>;</span><br><span class="line">            <span class="built_in">int</span> msgId=BitConverter.ToInt32(receiveBytes, index);</span><br><span class="line">            index += <span class="number">4</span>;</span><br><span class="line">            <span class="built_in">int</span> msgLen = BitConverter.ToInt32(receiveBytes, index);</span><br><span class="line">            index += <span class="number">4</span>;</span><br><span class="line">            BaseMsg baseMsg = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">switch</span> (msgId)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">1001</span>:</span><br><span class="line">                    baseMsg = <span class="keyword">new</span> PlayerDataMsg();</span><br><span class="line">                    baseMsg.Reading(receiveBytes, index);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">1003</span>:</span><br><span class="line">                    baseMsg = <span class="keyword">new</span> QuitMsg();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">1004</span>:</span><br><span class="line">                    baseMsg = <span class="keyword">new</span> HeardMsg();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(baseMsg == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;客户端：<span class="subst">&#123;<span class="keyword">this</span>.IPEndPoint&#125;</span> 发来未定义消息类型<span class="subst">&#123;msgId&#125;</span>&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                HandleMsg(baseMsg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">HandleMsg</span>(<span class="params">BaseMsg baseMsg</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!IsConnected) <span class="keyword">return</span>;</span><br><span class="line">        Console.Write(<span class="string">$&quot;客户端：<span class="subst">&#123;<span class="keyword">this</span>.IPEndPoint&#125;</span> 发来信息 :&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (baseMsg <span class="keyword">is</span> PlayerDataMsg)</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(baseMsg.ToString());</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (baseMsg <span class="keyword">is</span> QuitMsg)</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;退出信息&quot;</span>);</span><br><span class="line">            <span class="keyword">this</span>.Close();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (baseMsg <span class="keyword">is</span> HeardMsg)</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;心跳信息&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">internal</span> <span class="keyword">void</span> <span class="title">SendMsg</span>(<span class="params"><span class="built_in">byte</span>[] msg</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(!IsConnected ) <span class="keyword">return</span>;</span><br><span class="line">        ThreadPool.QueueUserWorkItem(SendMsgAsync, msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">SendMsgAsync</span>(<span class="params"><span class="built_in">object</span>? obj</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">byte</span>[] msg= obj <span class="keyword">as</span> <span class="built_in">byte</span>[];</span><br><span class="line">        ServerSocket.Instance.serverSocket.SendTo(msg,<span class="keyword">this</span>.IPEndPoint);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Close</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(IsConnected)</span><br><span class="line">        &#123;</span><br><span class="line">            IsConnected = <span class="literal">false</span>;</span><br><span class="line">            ServerSocket.Instance.AddTodeleteSocketList(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="客户端-1"><a href="#客户端-1" class="headerlink" title="客户端"></a>客户端</h3><p>客户端具备的功能：区分消息类型，发送接收信息，判断收到的信息不是服务端发来的则不处理</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">using</span> System.Net.Sockets;</span><br><span class="line"><span class="keyword">using</span> System.Threading;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UDPClientSocket</span> : <span class="title">SingletonMonoBehaviour</span>&lt;<span class="title">UDPClientSocket</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    Socket socket;</span><br><span class="line">    IPEndPoint iPEndPoint;</span><br><span class="line">    IPEndPoint serverIPEndPoint;</span><br><span class="line">    <span class="built_in">bool</span> isConnect = <span class="literal">false</span>;</span><br><span class="line">    Queue&lt;BaseMsg&gt;sendMsgQueue=<span class="keyword">new</span> Queue&lt;BaseMsg&gt;();</span><br><span class="line">    <span class="built_in">byte</span>[] receiveBytes=<span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">512</span>];</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.Awake();</span><br><span class="line">        ToStart(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8081</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ToStart</span>(<span class="params"><span class="built_in">string</span> ip, <span class="built_in">int</span> port</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        serverIPEndPoint = <span class="keyword">new</span> IPEndPoint(IPAddress.Parse(ip), <span class="number">8080</span>);</span><br><span class="line">        socket = <span class="keyword">new</span> Socket(AddressFamily.InterNetwork, SocketType.Dgram, ProtocolType.Udp);</span><br><span class="line">        <span class="keyword">this</span>.iPEndPoint = <span class="keyword">new</span> IPEndPoint(IPAddress.Parse(ip), port);</span><br><span class="line">        socket.Bind(iPEndPoint);</span><br><span class="line">        <span class="keyword">this</span>.isConnect = <span class="literal">true</span>;</span><br><span class="line">        Debug.Log(<span class="string">&quot;客户端启动成功&quot;</span>);</span><br><span class="line">        ThreadPool.QueueUserWorkItem(ReceiveThread);</span><br><span class="line">        ThreadPool.QueueUserWorkItem(SendThread);</span><br><span class="line">        AfterConnect();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">AfterConnect</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>.SendMsg(<span class="keyword">new</span> PlayerDataMsg(<span class="number">12020</span>, <span class="string">&quot;可短&quot;</span>, <span class="number">102</span>, <span class="number">1531</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ReceiveThread</span>(<span class="params"><span class="built_in">object</span> obj</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span>(isConnect)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(socket.Available&gt;<span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">try</span></span><br><span class="line">                &#123;</span><br><span class="line">                    EndPoint endPoint = <span class="keyword">new</span> IPEndPoint(IPAddress.Any, <span class="number">0</span>);</span><br><span class="line">                    <span class="built_in">int</span> receiveLen = socket.ReceiveFrom(receiveBytes, <span class="keyword">ref</span> endPoint);</span><br><span class="line">                    <span class="keyword">if</span> (!endPoint.Equals(<span class="keyword">this</span>.serverIPEndPoint))</span><br><span class="line">                    &#123;</span><br><span class="line">                        Debug.LogError(<span class="string">&quot;收到非服务端发来的信息！！&quot;</span>);</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    ThreadPool.QueueUserWorkItem(HandleReceive, receiveLen);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (SocketException e)</span><br><span class="line">                &#123;</span><br><span class="line">                    Debug.LogError(<span class="string">&quot;收到信息出错(Socket错误)：&quot;</span> + e.ErrorCode + <span class="string">&quot; &quot;</span> + e.Message);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (Exception e)</span><br><span class="line">                &#123;</span><br><span class="line">                    Debug.LogError(<span class="string">&quot;收到信息出错(非Socket错误)：&quot;</span> + e.Message);</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">HandleReceive</span>(<span class="params"><span class="built_in">object</span> obj</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">int</span> receiveLen = (<span class="built_in">int</span>)obj;</span><br><span class="line">        <span class="built_in">int</span> index = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">int</span> msgId;</span><br><span class="line">        <span class="built_in">int</span> msgLen;</span><br><span class="line">        msgId = BitConverter.ToInt32(receiveBytes, index);</span><br><span class="line">        index += <span class="number">4</span>;</span><br><span class="line">        msgLen =BitConverter.ToInt32(receiveBytes, index);</span><br><span class="line">        index += <span class="number">4</span>;</span><br><span class="line">        BaseMsg baseMsg = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">switch</span> (msgId)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1001</span>:</span><br><span class="line">                baseMsg = <span class="keyword">new</span> PlayerDataMsg();</span><br><span class="line">                baseMsg.Reading(receiveBytes, index);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        index += msgLen;</span><br><span class="line">        <span class="keyword">if</span>(baseMsg==<span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;服务端发来未定义消息类型：<span class="subst">&#123;msgId&#125;</span>&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            HandleReceiveMsg(baseMsg);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">HandleReceiveMsg</span>(<span class="params">BaseMsg baseMsg</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(baseMsg <span class="keyword">is</span> PlayerDataMsg)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(baseMsg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SendMsg</span>(<span class="params">BaseMsg msg</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (isConnect)</span><br><span class="line">            <span class="keyword">this</span>.sendMsgQueue.Enqueue(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SendBytes</span>(<span class="params"><span class="built_in">byte</span>[] bytes</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (isConnect)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.socket.SendTo(bytes, serverIPEndPoint);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">SendThread</span>(<span class="params"><span class="built_in">object</span> obj</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span> (isConnect)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.sendMsgQueue.Count &gt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    BaseMsg msg = <span class="keyword">this</span>.sendMsgQueue.Dequeue();</span><br><span class="line">                    <span class="keyword">this</span>.socket.SendTo(msg.Writeing(), serverIPEndPoint);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (SocketException e)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">&quot;发送信息出错(Socket错误)：&quot;</span> + e.ErrorCode + <span class="string">&quot; &quot;</span> + e.Message);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception e)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">&quot;发送信息出错(非Socket错误)：&quot;</span> + e.Message);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnDestroy</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Close</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(isConnect)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.SendBytes(<span class="keyword">new</span> QuitMsg().Writeing());</span><br><span class="line">            isConnect =<span class="literal">false</span>;</span><br><span class="line">            </span><br><span class="line">            socket.Shutdown(SocketShutdown.Both);</span><br><span class="line">            socket.Dispose();</span><br><span class="line">            socket.Close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="MTU"><a href="#MTU" class="headerlink" title="MTU"></a>MTU</h1><p>MTU（Maximum Transmission Unit）是指网络通信中一次能够发送的最大数据包大小。它是链路层协议规定的一个参数，决定了数据链路层上能够传输的最大数据长度。</p>
<p>MTU的大小是根据不同网络技术和设备而定的，常见的以太网的MTU通常为1500字节。当数据包的大小超过MTU时，需要进行分片处理，将数据包分成多个小的数据块进行传输，接收方再将这些小的数据块重新组装成完整的数据包。</p>
<p>MTU的大小对网络通信有一定的影响：</p>
<ol>
<li>性能：较大的MTU可以减少数据包的数量，降低传输的开销，提高传输效率和网络性能。</li>
<li>延迟：较大的MTU可以减少数据包的传输次数，从而降低传输的延迟。</li>
<li>丢包：较大的MTU可能会增加数据包被丢失的风险，因为在传输过程中，即使一个分片被丢失，整个数据包都需要重新发送。</li>
<li>可靠性：较大的MTU对传输可靠性要求更高，因为当一个分片丢失时，整个数据包需要重新发送，可能会导致一些数据重复传输。</li>
</ol>
<p>在进行网络通信时，应根据网络环境和应用需求合理设置MTU大小。如果网络环境较好，可以选择较大的MTU来提高性能和传输效率。但在一些特殊的网络环境或应用场景中，可能需要考虑网络的稳定性和可靠性，选择较小的MTU来减少丢包的风险。</p>
<p>在Unity中，可以使用<code>NetworkTransport</code>类的<code>GetMaxPacketSize</code>方法来获取当前平台的最大数据包大小。例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">csharpCopy codeint maxPacketSize = UnityEngine.Networking.NetworkTransport.GetMaxPacketSize();</span><br><span class="line">Debug.Log(&quot;Max Packet Size: &quot; + maxPacketSize);</span><br></pre></td></tr></table></figure>

<p>注意，这里使用的是Unity的高层网络库<code>UnityEngine.Networking</code>中的<code>NetworkTransport</code>类，它提供了底层的网络通信功能，包括UDP和TCP的支持。</p>
<h1 id="FTP协议"><a href="#FTP协议" class="headerlink" title="FTP协议"></a>FTP协议</h1><p>文件传输协议</p>
<p>FTP的本质是TCP连接，FTP需要建立两条TCP连接，一个称为控制链接，一个称为数据连接。</p>
<p>FTP（文件传输协议）是一种用于在计算机网络上进行文件传输的标准协议。它使用客户端-服务器模型，其中客户端通过FTP客户端程序与服务器进行通信。</p>
<p>控制连接（Control Connection）用于传输命令和控制信息。它在客户端和服务器之间建立，通常使用默认的FTP端口21。控制连接负责处理用户认证、命令传输和响应，以及管理文件操作等。</p>
<p>数据连接（Data Connection）用于实际的文件传输。数据连接在需要传输文件内容或目录列表等数据时建立，并在完成传输后关闭。数据连接可以在主动模式和被动模式下进行。在主动模式中，服务器主动连接客户端的数据端口进行数据传输，而在被动模式中，客户端主动连接服务器的数据端口。</p>
<p>控制连接和数据连接是独立的TCP连接，它们使用不同的端口进行通信。控制连接始终保持打开状态，用于控制和管理整个FTP会话。数据连接在需要传输文件或目录等数据时打开，传输完成后关闭。</p>
<p>通过建立控制连接和数据连接，FTP协议能够进行可靠的文件传输和管理。控制连接处理命令和控制消息，而数据连接用于实际的数据传输。这种分离的连接机制使得FTP协议更加灵活和可靠。</p>
<p>FTP通信的基本步骤如下：</p>
<ol>
<li>建立连接：客户端与服务器之间建立TCP连接，默认使用端口号21进行连接。</li>
<li>身份验证：客户端发送用户名和密码给服务器进行身份验证。如果验证成功，客户端可以进行文件操作；否则，访问将被拒绝。</li>
<li>执行文件操作：客户端可以使用FTP命令执行各种文件操作，如上传文件、下载文件、删除文件、重命名文件等。这些操作需要使用特定的FTP命令，如STOR（存储文件）、RETR（检索文件）、DELE（删除文件）等。</li>
<li>数据传输：文件传输过程中，数据可以通过两种模式进行传输：主动模式（Active Mode）和被动模式（Passive Mode）。在主动模式下，服务器主动连接客户端的数据端口；而在被动模式下，客户端主动连接服务器的数据端口。</li>
<li>断开连接：通信结束后，客户端和服务器可以选择断开连接，释放资源。</li>
</ol>
<p>需要注意的是，FTP通信在传输过程中并不加密，因此数据可能会被窃取或篡改。为了提高安全性，可以使用安全的FTP协议（如FTPS或SFTP）或通过VPN等安全通道进行FTP通信。</p>
<p>SerV-U：用于搭建一个FTP服务器</p>
<h2 id="FTP相关类"><a href="#FTP相关类" class="headerlink" title="FTP相关类"></a>FTP相关类</h2><p>在C#中，可以使用.NET Framework或.NET Core提供的相关类和库来实现FTP通信。以下是一些常用的FTP通信相关类：</p>
<ol>
<li><code>System.Net.FtpWebRequest</code>：用于创建和发送FTP请求的类。它提供了与FTP服务器进行通信的功能，包括上传文件、下载文件、创建目录、删除文件等操作。</li>
<li><code>System.Net.FtpWebResponse</code>：用于处理FTP服务器的响应。它提供了访问FTP服务器响应的属性和方法，例如响应状态码、响应头信息等。</li>
<li><code>System.Net.NetworkCredential</code>：用于存储FTP服务器的身份验证信息，包括用户名和密码。</li>
<li><code>System.IO.Stream</code>：用于处理FTP数据流的抽象基类。它提供了读取和写入数据的方法，可用于处理从FTP服务器下载的文件或上传到FTP服务器的文件。</li>
</ol>
<p>使用这些类，您可以构建FTP通信的功能，例如连接到FTP服务器、执行各种操作，并处理服务器的响应和数据传输。</p>
<p>以下是一个示例代码，演示了如何使用<code>FtpWebRequest</code>和<code>FtpWebResponse</code>类来上传文件到FTP服务器：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title">FtpUploader</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// FTP服务器的地址、用户名和密码</span></span><br><span class="line">        <span class="built_in">string</span> ftpServer = <span class="string">&quot;ftp://example.com/&quot;</span>;</span><br><span class="line">        <span class="built_in">string</span> username = <span class="string">&quot;username&quot;</span>;</span><br><span class="line">        <span class="built_in">string</span> password = <span class="string">&quot;password&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 本地文件的路径</span></span><br><span class="line">        <span class="built_in">string</span> localFilePath = <span class="string">&quot;C:\\path\\to\\file.txt&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 远程文件在FTP服务器上的路径和文件名</span></span><br><span class="line">        <span class="built_in">string</span> remoteFilePath = <span class="string">&quot;/path/to/remote/file.txt&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 创建FTP请求对象</span></span><br><span class="line">            FtpWebRequest request = (FtpWebRequest)WebRequest.Create(ftpServer + remoteFilePath);</span><br><span class="line">            request.Method = WebRequestMethods.Ftp.UploadFile;</span><br><span class="line">            request.Credentials = <span class="keyword">new</span> NetworkCredential(username, password);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 读取本地文件数据</span></span><br><span class="line">            <span class="keyword">using</span> (Stream fileStream = File.OpenRead(localFilePath))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 获取FTP请求的数据流</span></span><br><span class="line">                <span class="keyword">using</span> (Stream ftpStream = request.GetRequestStream())</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 将本地文件数据写入FTP请求的数据流</span></span><br><span class="line">                    fileStream.CopyTo(ftpStream);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取FTP服务器的响应</span></span><br><span class="line">            FtpWebResponse response = (FtpWebResponse)request.GetResponse();</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;Upload Complete, status: &#123;0&#125;&quot;</span>, response.StatusDescription);</span><br><span class="line">            response.Close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (WebException ex)</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;Error: &#123;0&#125;&quot;</span>, ex.Message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在上面的示例中，通过创建<code>FtpWebRequest</code>对象并设置相关属性（如请求方法、凭据等），然后使用<code>GetRequestStream</code>方法获取FTP请求的数据流，并将本地文件数据复制到FTP请求的数据流中，实现了将文件上传到FTP服务器的功能。</p>
<p>请注意，以上示例只演示了文件上传的基本操作，实际应用中可能需要处理更多的异常情况、添加身份验证和错误处理等。根据具体需求，您可以进一步使用FTP相关类来实现其他FTP通信操作，例如下载文件、列出目录内容等。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Lesson19</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Start is called before the first frame update</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 知识点一 NetworkCredential类</span></span><br><span class="line">        <span class="comment">//命名空间：System.Net</span></span><br><span class="line">        <span class="comment">//NetworkCredential通信凭证类</span></span><br><span class="line">        <span class="comment">//用于在Ftp文件传输时，设置账号密码</span></span><br><span class="line">        NetworkCredential n = <span class="keyword">new</span> NetworkCredential(<span class="string">&quot;MrTang&quot;</span>, <span class="string">&quot;MrTang123&quot;</span>);</span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 知识点二 FtpWebRequest类</span></span><br><span class="line">        <span class="comment">//命名空间：System.Net</span></span><br><span class="line">        <span class="comment">//Ftp文件传输协议客户端操作类</span></span><br><span class="line">        <span class="comment">//主要用于：上传、下载、删除服务器上的文件</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//重要方法</span></span><br><span class="line">        <span class="comment">//1.Create 创建新的WebRequest，用于进行Ftp相关操作</span></span><br><span class="line">        FtpWebRequest req = FtpWebRequest.Create(<span class="keyword">new</span> Uri(<span class="string">&quot;ftp://127.0.0.1/Test.txt&quot;</span>)) <span class="keyword">as</span> FtpWebRequest;</span><br><span class="line">        <span class="comment">//2.Abort  如果正在进行文件传输，用此方法可以终止传输</span></span><br><span class="line">        req.Abort();</span><br><span class="line">        <span class="comment">//3.GetRequestStream  获取用于上传的流</span></span><br><span class="line">        Stream s = req.GetRequestStream();</span><br><span class="line">        <span class="comment">//4.GetResponse  返回FTP服务器响应</span></span><br><span class="line">        <span class="comment">//FtpWebResponse res = req.GetResponse() as FtpWebResponse;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//重要成员</span></span><br><span class="line">        <span class="comment">//1.Credentials 通信凭证，设置为NetworkCredential对象</span></span><br><span class="line">        req.Credentials = n;</span><br><span class="line">        <span class="comment">//2.KeepAlive bool值，当完成请求时是否关闭到FTP服务器的控制连接（默认为true，不关闭）</span></span><br><span class="line">        req.KeepAlive = <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">//3.Method  操作命令设置</span></span><br><span class="line">        <span class="comment">//  WebRequestMethods.Ftp类中的操作命令属性</span></span><br><span class="line">        <span class="comment">//  DeleteFile  删除文件</span></span><br><span class="line">        <span class="comment">//  DownloadFile    下载文件    </span></span><br><span class="line">        <span class="comment">//  ListDirectory   获取文件简短列表</span></span><br><span class="line">        <span class="comment">//  ListDirectoryDetails    获取文件详细列表</span></span><br><span class="line">        <span class="comment">//  MakeDirectory   创建目录</span></span><br><span class="line">        <span class="comment">//  RemoveDirectory 删除目录</span></span><br><span class="line">        <span class="comment">//  UploadFile  上传文件</span></span><br><span class="line">        req.Method = WebRequestMethods.Ftp.DownloadFile;</span><br><span class="line">        <span class="comment">//4.UseBinary 是否使用2进制传输</span></span><br><span class="line">        req.UseBinary = <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">//5.RenameTo    重命名</span></span><br><span class="line">        <span class="comment">//req.RenameTo = &quot;myTest.txt&quot;;</span></span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 知识点三 FtpWebResponse类</span></span><br><span class="line">        <span class="comment">//命名空间：System.Net</span></span><br><span class="line">        <span class="comment">//它是用于封装FTP服务器对请求的响应</span></span><br><span class="line">        <span class="comment">//它提供操作状态以及从服务器下载数据</span></span><br><span class="line">        <span class="comment">//我们可以通过FtpWebRequest对象中的GetResponse()方法获取</span></span><br><span class="line">        <span class="comment">//当使用完毕时，要使用Close释放</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//通过它来真正的从服务器获取内容</span></span><br><span class="line">        FtpWebResponse res = req.GetResponse() <span class="keyword">as</span> FtpWebResponse;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//重要方法：</span></span><br><span class="line">        <span class="comment">//1.Close:释放所有资源</span></span><br><span class="line">        res.Close();</span><br><span class="line">        <span class="comment">//2.GetResponseStream：返回从FTP服务器下载数据的流</span></span><br><span class="line">        Stream stream = res.GetResponseStream();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//重要成员：</span></span><br><span class="line">        <span class="comment">//1.ContentLength:接受到数据的长度</span></span><br><span class="line">        print(res.ContentLength);</span><br><span class="line">        <span class="comment">//2.ContentType：接受数据的类型</span></span><br><span class="line">        print(res.ContentType);</span><br><span class="line">        <span class="comment">//3.StatusCode:FTP服务器下发的最新状态码</span></span><br><span class="line">        print(res.StatusCode);</span><br><span class="line">        <span class="comment">//4.StatusDescription:FTP服务器下发的状态代码的文本</span></span><br><span class="line">        print(res.StatusDescription);</span><br><span class="line">        <span class="comment">//5.BannerMessage:登录前建立连接时FTP服务器发送的消息</span></span><br><span class="line">        print(res.BannerMessage);</span><br><span class="line">        <span class="comment">//6.ExitMessage:FTP会话结束时服务器发送的消息</span></span><br><span class="line">        <span class="comment">//7.LastModified:FTP服务器上的文件的上次修改日期和时间</span></span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 总结</span></span><br><span class="line">        <span class="comment">//通过C#提供的这3个类</span></span><br><span class="line">        <span class="comment">//我们便可以完成客户端向FTP服务器</span></span><br><span class="line">        <span class="comment">//操作文件的需求，比如</span></span><br><span class="line">        <span class="comment">//上传、下载、删除文件</span></span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update is called once per frame</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="简单FTP上传"><a href="#简单FTP上传" class="headerlink" title="简单FTP上传"></a>简单FTP上传</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Lesson20</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Start is called before the first frame update</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 知识点一 使用FTP上传文件关键点</span></span><br><span class="line">        <span class="comment">//1.通信凭证</span></span><br><span class="line">        <span class="comment">//  进行Ftp连接操作时需要的账号密码</span></span><br><span class="line">        <span class="comment">//2.操作命令 WebRequestMethods.Ftp</span></span><br><span class="line">        <span class="comment">//  设置你想要进行的Ftp操作</span></span><br><span class="line">        <span class="comment">//3.文件流相关 FileStream 和 Stream</span></span><br><span class="line">        <span class="comment">//  上传和下载时都会使用的文件流</span></span><br><span class="line">        <span class="comment">//4.保证FTP服务器已经开启</span></span><br><span class="line">        <span class="comment">//  并且能够正常访问</span></span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 知识点二 FTP上传</span></span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//1.创建一个Ftp连接</span></span><br><span class="line">            FtpWebRequest req = FtpWebRequest.Create(<span class="keyword">new</span> Uri(<span class="string">&quot;ftp://192.168.50.49/pic.png&quot;</span>)) <span class="keyword">as</span> FtpWebRequest;</span><br><span class="line">            <span class="comment">//2.设置通信凭证(如果不支持匿名 就必须设置这一步)</span></span><br><span class="line">            <span class="comment">//将代理相关信息置空 避免 服务器同时有http相关服务 造成冲突</span></span><br><span class="line">            req.Proxy = <span class="literal">null</span>;</span><br><span class="line">            NetworkCredential n = <span class="keyword">new</span> NetworkCredential(<span class="string">&quot;MrTang&quot;</span>, <span class="string">&quot;MrTang123&quot;</span>);</span><br><span class="line">            req.Credentials = n;</span><br><span class="line">            <span class="comment">//请求完毕后 是否关闭控制连接，如果想要关闭，可以设置为false</span></span><br><span class="line">            req.KeepAlive = <span class="literal">false</span>;</span><br><span class="line">            <span class="comment">//3.设置操作命令</span></span><br><span class="line">            req.Method = WebRequestMethods.Ftp.UploadFile;<span class="comment">//设置命令操作为 上传文件</span></span><br><span class="line">            <span class="comment">//4.指定传输类型</span></span><br><span class="line">            req.UseBinary = <span class="literal">true</span>;</span><br><span class="line">            <span class="comment">//5.得到用于上传的流对象</span></span><br><span class="line">            Stream upLoadStream = req.GetRequestStream();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//6.开始上传</span></span><br><span class="line">            <span class="keyword">using</span> (FileStream file = File.OpenRead(Application.streamingAssetsPath + <span class="string">&quot;/test.png&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//我们可以一点一点的把这个文件中的字节数组读取出来 然后存入到 上传流中</span></span><br><span class="line">                <span class="built_in">byte</span>[] bytes = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">1024</span>];</span><br><span class="line"></span><br><span class="line">                <span class="comment">//返回值 是真正从文件中读了多少个字节</span></span><br><span class="line">                <span class="built_in">int</span> contentLength = file.Read(bytes, <span class="number">0</span>, bytes.Length);</span><br><span class="line">                <span class="comment">//不停的去读取文件中的字节 除非读取完毕了 不然一直读 并且写入到上传流中</span></span><br><span class="line">                <span class="keyword">while</span> (contentLength != <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//写入上传流中</span></span><br><span class="line">                    upLoadStream.Write(bytes, <span class="number">0</span>, contentLength);</span><br><span class="line">                    <span class="comment">//写完了继续读</span></span><br><span class="line">                    contentLength = file.Read(bytes, <span class="number">0</span>, bytes.Length);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//除了循环就证明 写完了 </span></span><br><span class="line">                file.Close();</span><br><span class="line">                upLoadStream.Close();</span><br><span class="line">                <span class="comment">//上传完毕</span></span><br><span class="line">                print(<span class="string">&quot;上传结束&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception e)</span><br><span class="line">        &#123;</span><br><span class="line">            print(<span class="string">&quot;上传出错 失败&quot;</span> + e.Message);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 总结</span></span><br><span class="line">        <span class="comment">//C#已经把Ftp相关操作封装的很好了</span></span><br><span class="line">        <span class="comment">//我们只需要熟悉API，直接使用他们进行FTP上传即可</span></span><br><span class="line">        <span class="comment">//我们主要做的操作是</span></span><br><span class="line">        <span class="comment">//把本地文件流读出字节数据写入到要上传的FTP流中</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//FTP上传相关API也有异步方法</span></span><br><span class="line">        <span class="comment">//使用上和以前的TCP相关类似</span></span><br><span class="line">        <span class="comment">//这里不赘述</span></span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update is called once per frame</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="异步上传"><a href="#异步上传" class="headerlink" title="异步上传"></a>异步上传</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Send</span> : <span class="title">Singleton</span>&lt;<span class="title">Send</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">string</span> NAME = <span class="string">&quot;125800&quot;</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">string</span> PASSWORD = <span class="string">&quot;125800&quot;</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">string</span> romatUrl = <span class="string">&quot;ftp://192.168.200.27/&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> NetworkCredential networkCredential;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Initialize</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.Initialize();</span><br><span class="line">        networkCredential = <span class="keyword">new</span> NetworkCredential(NAME, PASSWORD);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> <span class="keyword">void</span> <span class="title">SendToServer</span>(<span class="params"><span class="built_in">string</span> serverFileName, <span class="built_in">string</span> fileName</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">await</span> Task.Run(() =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                FtpWebRequest request = FtpWebRequest.Create(<span class="keyword">new</span> Uri(romatUrl + serverFileName)) <span class="keyword">as</span> FtpWebRequest;</span><br><span class="line">                request.Credentials = networkCredential;</span><br><span class="line">                request.KeepAlive = <span class="literal">false</span>;</span><br><span class="line">                request.Proxy = <span class="literal">null</span>;</span><br><span class="line">                request.Method = WebRequestMethods.Ftp.UploadFile;</span><br><span class="line">                request.UseBinary = <span class="literal">true</span>;</span><br><span class="line">                Stream serverStream = request.GetRequestStream();</span><br><span class="line">                <span class="keyword">try</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">using</span> (FileStream file = File.OpenRead(fileName))</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">byte</span>[] bytes = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                        <span class="built_in">int</span> bytesLen = <span class="number">0</span>;</span><br><span class="line">                        <span class="keyword">do</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            </span><br><span class="line">                            bytesLen = file.Read(bytes, <span class="number">0</span>, bytes.Length);</span><br><span class="line">                            Console.WriteLine(bytesLen);</span><br><span class="line">                            serverStream.Write(bytes, <span class="number">0</span>, bytesLen);</span><br><span class="line">                        &#125; <span class="keyword">while</span> (bytesLen &gt; <span class="number">0</span>);</span><br><span class="line">                        file.Close();</span><br><span class="line">                        serverStream.Close();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (Exception e)</span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(e.Message);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception e)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(e.Message);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;);</span><br><span class="line">       </span><br><span class="line">        Console.WriteLine(<span class="string">&quot;信息发送成功&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SendToServerTest</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            FtpWebRequest request = FtpWebRequest.Create(<span class="keyword">new</span> Uri(<span class="string">&quot;ftp://192.168.200.27/x.png&quot;</span>)) <span class="keyword">as</span> FtpWebRequest;</span><br><span class="line">            NetworkCredential networkCredential = <span class="keyword">new</span> NetworkCredential(<span class="string">&quot;125800&quot;</span>, <span class="string">&quot;125800&quot;</span>);</span><br><span class="line">            request.Proxy = <span class="literal">null</span>;</span><br><span class="line">            request.Credentials = networkCredential;</span><br><span class="line">            request.KeepAlive = <span class="literal">false</span>;</span><br><span class="line">            request.Method = WebRequestMethods.Ftp.UploadFile;</span><br><span class="line">            <span class="comment">//使用二进制进行传输</span></span><br><span class="line">            request.UseBinary = <span class="literal">true</span>;</span><br><span class="line">            Stream upLoadStream = request.GetRequestStream();</span><br><span class="line">            <span class="keyword">using</span> (FileStream file = File.OpenRead(<span class="string">&quot;C:\\Users\\DELL\\Desktop\\Ftp\\x.png&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">byte</span>[] upLodeBytes = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">512</span>];</span><br><span class="line">                <span class="built_in">int</span> bytesLen = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">do</span></span><br><span class="line">                &#123;</span><br><span class="line">                    bytesLen = file.Read(upLodeBytes, <span class="number">0</span>, upLodeBytes.Length);</span><br><span class="line">                    upLoadStream.Write(upLodeBytes, <span class="number">0</span>, bytesLen);</span><br><span class="line">                &#125; <span class="keyword">while</span> (bytesLen != <span class="number">0</span>);</span><br><span class="line">                file.Close();</span><br><span class="line">                upLoadStream.Close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception e)</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(e.Message);</span><br><span class="line">        &#125;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;信息发送成功&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="异步下载"><a href="#异步下载" class="headerlink" title="异步下载"></a>异步下载</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DownLode</span>:<span class="title">Singleton</span>&lt;<span class="title">DownLode</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">string</span> NAME = <span class="string">&quot;125800&quot;</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">string</span> PASSWORD = <span class="string">&quot;125800&quot;</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">string</span> romatUrl = <span class="string">&quot;ftp://192.168.200.27/&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> NetworkCredential networkCredential;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Initialize</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.Initialize();</span><br><span class="line">        networkCredential = <span class="keyword">new</span> NetworkCredential(NAME, PASSWORD);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> <span class="keyword">void</span> <span class="title">DownLodeAsync</span>(<span class="params"><span class="built_in">string</span> serverFileName, <span class="built_in">string</span> fileName</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">await</span> Task.Run(() =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                FtpWebRequest request = FtpWebRequest.Create(<span class="keyword">new</span> Uri(romatUrl + serverFileName)) <span class="keyword">as</span> FtpWebRequest;</span><br><span class="line">                request.Proxy = <span class="literal">null</span>;</span><br><span class="line">                request.Credentials = <span class="keyword">this</span>.networkCredential;</span><br><span class="line">                request.UseBinary = <span class="literal">true</span>;</span><br><span class="line">                request.KeepAlive = <span class="literal">false</span>;</span><br><span class="line">                request.Method = WebRequestMethods.Ftp.DownloadFile;</span><br><span class="line"></span><br><span class="line">                FtpWebResponse response = request.GetResponse() <span class="keyword">as</span> FtpWebResponse;</span><br><span class="line">                Stream serverStream = response.GetResponseStream();</span><br><span class="line">                <span class="keyword">using</span> (FileStream file = File.Create(fileName))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">byte</span>[] bytes = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                    <span class="built_in">int</span> bytesLen = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">do</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        bytesLen=serverStream.Read(bytes, <span class="number">0</span>, bytes.Length);</span><br><span class="line">                        file.Write(bytes, <span class="number">0</span>, bytesLen);</span><br><span class="line">                        Console.WriteLine(bytesLen);</span><br><span class="line">                    &#125; <span class="keyword">while</span> (bytesLen &gt; <span class="number">0</span>);</span><br><span class="line">                    file.Close();</span><br><span class="line">                    serverStream.Close();</span><br><span class="line">                &#125;</span><br><span class="line">                    </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception e)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;下载时出错：&quot;</span>+e.Message);</span><br><span class="line">            &#125;</span><br><span class="line">            response.close();</span><br><span class="line">            </span><br><span class="line">        &#125;);</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;serverFileName&#125;</span> 下载完成&quot;</span>);</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="XML配置协议"><a href="#XML配置协议" class="headerlink" title="XML配置协议"></a>XML配置协议</h1><h2 id="xml文件"><a href="#xml文件" class="headerlink" title="xml文件"></a>xml文件</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">messages</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--枚举配置规则--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">enum</span> <span class="attr">name</span>=<span class="string">&quot;E_PLAYER_TYPE&quot;</span> <span class="attr">namespace</span>=<span class="string">&quot;GamePlayer&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;MAIN&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;OTHER&quot;</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">enum</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">enum</span> <span class="attr">name</span>=<span class="string">&quot;E_MONSTER_TYPE&quot;</span> <span class="attr">namespace</span>=<span class="string">&quot;GameMonster&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;NORMAL&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;BOSS&quot;</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">enum</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--数据结构类配置规则--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">data</span> <span class="attr">name</span>=<span class="string">&quot;PlayerData&quot;</span> <span class="attr">namespace</span>=<span class="string">&quot;GamePlayer&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">field</span> <span class="attr">type</span>=<span class="string">&quot;int&quot;</span> <span class="attr">name</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">field</span> <span class="attr">type</span>=<span class="string">&quot;float&quot;</span> <span class="attr">name</span>=<span class="string">&quot;atk&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">field</span> <span class="attr">type</span>=<span class="string">&quot;bool&quot;</span> <span class="attr">name</span>=<span class="string">&quot;sex&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">field</span> <span class="attr">type</span>=<span class="string">&quot;long&quot;</span> <span class="attr">name</span>=<span class="string">&quot;lev&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">field</span> <span class="attr">type</span>=<span class="string">&quot;array&quot;</span> <span class="attr">name</span>=<span class="string">&quot;arrays&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">field</span> <span class="attr">type</span>=<span class="string">&quot;list&quot;</span> <span class="attr">T</span>=<span class="string">&quot;int&quot;</span> <span class="attr">name</span>=<span class="string">&quot;list&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">field</span> <span class="attr">type</span>=<span class="string">&quot;dic&quot;</span> <span class="attr">Tkey</span>=<span class="string">&quot;int&quot;</span> <span class="attr">Tvalue</span>=<span class="string">&quot;string&quot;</span> <span class="attr">name</span>=<span class="string">&quot;dic&quot;</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--消息类类配置规则--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">message</span> <span class="attr">id</span>=<span class="string">&quot;1001&quot;</span> <span class="attr">name</span>=<span class="string">&quot;PlayerMsg&quot;</span> <span class="attr">namespace</span>=<span class="string">&quot;GamePlayer&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">field</span> <span class="attr">type</span>=<span class="string">&quot;int&quot;</span> <span class="attr">name</span>=<span class="string">&quot;playerID&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">field</span> <span class="attr">type</span>=<span class="string">&quot;PlayerData&quot;</span> <span class="attr">name</span>=<span class="string">&quot;data&quot;</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">message</span> <span class="attr">id</span>=<span class="string">&quot;1002&quot;</span> <span class="attr">name</span>=<span class="string">&quot;HeartMsg&quot;</span> <span class="attr">namespace</span>=<span class="string">&quot;GameSystem&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">messages</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="解析XML文件"><a href="#解析XML文件" class="headerlink" title="解析XML文件"></a>解析XML文件</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Xml.Linq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        XDocument doc = XDocument.Load(<span class="string">&quot;example.xml&quot;</span>);</span><br><span class="line"></span><br><span class="line">        XElement root = doc.Root;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 解析枚举配置规则</span></span><br><span class="line">        <span class="keyword">foreach</span> (XElement enumElement <span class="keyword">in</span> root.Elements(<span class="string">&quot;enum&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">string</span> enumName = enumElement.Attribute(<span class="string">&quot;name&quot;</span>)?.Value;</span><br><span class="line">            <span class="built_in">string</span> namespaceName = enumElement.Attribute(<span class="string">&quot;namespace&quot;</span>)?.Value;</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;Enum Name: <span class="subst">&#123;enumName&#125;</span>&quot;</span>);</span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;Namespace: <span class="subst">&#123;namespaceName&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> (XElement fieldElement <span class="keyword">in</span> enumElement.Elements(<span class="string">&quot;field&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">string</span> fieldName = fieldElement.Attribute(<span class="string">&quot;name&quot;</span>)?.Value;</span><br><span class="line">                <span class="built_in">string</span> fieldValue = fieldElement.Value;</span><br><span class="line"></span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;Field Name: <span class="subst">&#123;fieldName&#125;</span>&quot;</span>);</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;Field Value: <span class="subst">&#123;fieldValue&#125;</span>&quot;</span>);</span><br><span class="line">                Console.WriteLine();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 解析数据结构类配置规则</span></span><br><span class="line">        <span class="keyword">foreach</span> (XElement dataElement <span class="keyword">in</span> root.Elements(<span class="string">&quot;data&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">string</span> dataName = dataElement.Attribute(<span class="string">&quot;name&quot;</span>)?.Value;</span><br><span class="line">            <span class="built_in">string</span> namespaceName = dataElement.Attribute(<span class="string">&quot;namespace&quot;</span>)?.Value;</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;Data Name: <span class="subst">&#123;dataName&#125;</span>&quot;</span>);</span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;Namespace: <span class="subst">&#123;namespaceName&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> (XElement fieldElement <span class="keyword">in</span> dataElement.Elements(<span class="string">&quot;field&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">string</span> fieldType = fieldElement.Attribute(<span class="string">&quot;type&quot;</span>)?.Value;</span><br><span class="line">                <span class="built_in">string</span> fieldName = fieldElement.Attribute(<span class="string">&quot;name&quot;</span>)?.Value;</span><br><span class="line"></span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;Field Type: <span class="subst">&#123;fieldType&#125;</span>&quot;</span>);</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;Field Name: <span class="subst">&#123;fieldName&#125;</span>&quot;</span>);</span><br><span class="line">                Console.WriteLine();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 解析消息类配置规则</span></span><br><span class="line">        <span class="keyword">foreach</span> (XElement messageElement <span class="keyword">in</span> root.Elements(<span class="string">&quot;message&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">string</span> messageId = messageElement.Attribute(<span class="string">&quot;id&quot;</span>)?.Value;</span><br><span class="line">            <span class="built_in">string</span> messageName = messageElement.Attribute(<span class="string">&quot;name&quot;</span>)?.Value;</span><br><span class="line">            <span class="built_in">string</span> namespaceName = messageElement.Attribute(<span class="string">&quot;namespace&quot;</span>)?.Value;</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;Message ID: <span class="subst">&#123;messageId&#125;</span>&quot;</span>);</span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;Message Name: <span class="subst">&#123;messageName&#125;</span>&quot;</span>);</span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;Namespace: <span class="subst">&#123;namespaceName&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> (XElement fieldElement <span class="keyword">in</span> messageElement.Elements(<span class="string">&quot;field&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">string</span> fieldType = fieldElement.Attribute(<span class="string">&quot;type&quot;</span>)?.Value;</span><br><span class="line">                <span class="built_in">string</span> fieldName = fieldElement.Attribute(<span class="string">&quot;name&quot;</span>)?.Value;</span><br><span class="line"></span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;Field Type: <span class="subst">&#123;fieldType&#125;</span>&quot;</span>);</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;Field Name: <span class="subst">&#123;fieldName&#125;</span>&quot;</span>);</span><br><span class="line">                Console.WriteLine();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="生成枚举类型"><a href="#生成枚举类型" class="headerlink" title="生成枚举类型"></a>生成枚举类型</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Xml;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">GamePlayer</span><span class="comment">//1</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">enum</span> E_Player_Type</span><br><span class="line">    &#123;</span><br><span class="line">        Main,</span><br><span class="line">        Other,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PlayerTest</span> : <span class="title">BaseData</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> List&lt;<span class="built_in">int</span>&gt; list;</span><br><span class="line">        <span class="keyword">public</span> Dictionary&lt;<span class="built_in">int</span>, <span class="built_in">string</span>&gt; dic;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span>[] arrays;</span><br><span class="line">        <span class="keyword">public</span> E_Player_Type type;</span><br><span class="line">        <span class="keyword">public</span> PlayerData player;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">int</span> <span class="title">GetBytesNum</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">int</span> num = <span class="number">0</span>;</span><br><span class="line">            num += <span class="number">4</span>;<span class="comment">//list.Count</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; list.Count; i++)</span><br><span class="line">                num += <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">            num += <span class="number">4</span>;<span class="comment">//dic.Count</span></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="built_in">int</span> key <span class="keyword">in</span> dic.Keys)</span><br><span class="line">            &#123;</span><br><span class="line">                num += <span class="number">4</span>;<span class="comment">//key所占的字节数</span></span><br><span class="line">                num += <span class="number">4</span>;<span class="comment">//value 字符串长度 占的字节数</span></span><br><span class="line">                num += Encoding.UTF8.GetByteCount(dic[key]);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            num += <span class="number">4</span>;<span class="comment">//arrays.Length</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; arrays.Length; i++)</span><br><span class="line">                num += <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">            num += <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">            num += player.GetBytesNum();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> num;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">int</span> <span class="title">Reading</span>(<span class="params"><span class="built_in">byte</span>[] bytes, <span class="built_in">int</span> beginIndex = <span class="number">0</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">int</span> index = beginIndex;</span><br><span class="line"></span><br><span class="line">            list = <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;();<span class="comment">//初始化规则</span></span><br><span class="line">            <span class="built_in">short</span> listCount = ReadShort(bytes, <span class="keyword">ref</span> index);</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; listCount; i++)</span><br><span class="line">                list.Add(ReadInt(bytes, <span class="keyword">ref</span> index));</span><br><span class="line"></span><br><span class="line">            dic = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">int</span>, <span class="built_in">string</span>&gt;();<span class="comment">//初始化规则</span></span><br><span class="line">            <span class="built_in">short</span> dicCount = ReadShort(bytes, <span class="keyword">ref</span> index);</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; dicCount; i++)</span><br><span class="line">                dic.Add(ReadInt(bytes, <span class="keyword">ref</span> index), ReadString(bytes, <span class="keyword">ref</span> index));</span><br><span class="line"></span><br><span class="line">            <span class="built_in">short</span> arraysLength = ReadShort(bytes, <span class="keyword">ref</span> index);</span><br><span class="line">            arrays = <span class="keyword">new</span> <span class="built_in">int</span>[arraysLength];<span class="comment">//初始化规则</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; arraysLength; i++)</span><br><span class="line">                arrays[i] = ReadInt(bytes, <span class="keyword">ref</span> index);</span><br><span class="line"></span><br><span class="line">            type = (E_Player_Type)ReadInt(bytes, <span class="keyword">ref</span> index);</span><br><span class="line"></span><br><span class="line">            player = ReadData&lt;PlayerData&gt;(bytes, <span class="keyword">ref</span> index);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> index - beginIndex;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">byte</span>[] <span class="title">Writing</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//固定内容</span></span><br><span class="line">            <span class="built_in">int</span> index = <span class="number">0</span>;</span><br><span class="line">            <span class="built_in">byte</span>[] bytes = <span class="keyword">new</span> <span class="built_in">byte</span>[GetBytesNum()];</span><br><span class="line"></span><br><span class="line">            <span class="comment">//可变的 是根据成员变量来决定如何拼接的</span></span><br><span class="line">            <span class="comment">//存储list的长度</span></span><br><span class="line">            WriteShort(bytes, (<span class="built_in">short</span>)list.Count, <span class="keyword">ref</span> index);</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; list.Count; i++)</span><br><span class="line">                WriteInt(bytes, list[i], <span class="keyword">ref</span> index);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//存储Dictionary的内容</span></span><br><span class="line">            <span class="comment">//长度</span></span><br><span class="line">            WriteShort(bytes, (<span class="built_in">short</span>)dic.Count, <span class="keyword">ref</span> index);</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="built_in">int</span> key <span class="keyword">in</span> dic.Keys)</span><br><span class="line">            &#123;</span><br><span class="line">                WriteInt(bytes, key, <span class="keyword">ref</span> index);</span><br><span class="line">                WriteString(bytes, dic[key], <span class="keyword">ref</span> index);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//存储数组的长度</span></span><br><span class="line">            WriteShort(bytes, (<span class="built_in">short</span>)arrays.Length, <span class="keyword">ref</span> index);</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; arrays.Length; i++)</span><br><span class="line">                WriteInt(bytes, arrays[i], <span class="keyword">ref</span> index);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//枚举</span></span><br><span class="line">            WriteInt(bytes, Convert.ToInt32(type), <span class="keyword">ref</span> index);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//自定义数据结构类</span></span><br><span class="line">            WriteData(bytes, player, <span class="keyword">ref</span> index);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//固定内容</span></span><br><span class="line">            <span class="keyword">return</span> bytes;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GenerateCSharp</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//协议保存路径</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> SAVE_PATH = Application.dataPath + <span class="string">&quot;/Scripts/Protocol/&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//生成枚举</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GenerateEnum</span>(<span class="params">XmlNodeList nodes</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//生成枚举脚本的逻辑</span></span><br><span class="line">        <span class="built_in">string</span> namespaceStr = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="built_in">string</span> enumNameStr = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="built_in">string</span> fieldStr = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (XmlNode enumNode <span class="keyword">in</span> nodes)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//获取命名空间配置信息</span></span><br><span class="line">            namespaceStr = enumNode.Attributes[<span class="string">&quot;namespace&quot;</span>].Value;</span><br><span class="line">            <span class="comment">//获取枚举名配置信息</span></span><br><span class="line">            enumNameStr = enumNode.Attributes[<span class="string">&quot;name&quot;</span>].Value;</span><br><span class="line">            <span class="comment">//获取所有的字段节点 然后进行字符串拼接</span></span><br><span class="line">            XmlNodeList enumFields = enumNode.SelectNodes(<span class="string">&quot;field&quot;</span>);</span><br><span class="line">            <span class="comment">//一个新的枚举 需要清空一次上一次拼接的字段字符串</span></span><br><span class="line">            fieldStr = <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">foreach</span> (XmlNode enumField <span class="keyword">in</span> enumFields)</span><br><span class="line">            &#123;</span><br><span class="line">                fieldStr += <span class="string">&quot;\t\t&quot;</span> + enumField.Attributes[<span class="string">&quot;name&quot;</span>].Value;</span><br><span class="line">                <span class="keyword">if</span> (enumField.InnerText != <span class="string">&quot;&quot;</span>)</span><br><span class="line">                    fieldStr += <span class="string">&quot; = &quot;</span> + enumField.InnerText;</span><br><span class="line">                fieldStr += <span class="string">&quot;,\r\n&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//对所有可变的内容进行拼接</span></span><br><span class="line">            <span class="built_in">string</span> enumStr = <span class="string">$&quot;namespace <span class="subst">&#123;namespaceStr&#125;</span>\r\n&quot;</span> +</span><br><span class="line">                             <span class="string">&quot;&#123;\r\n&quot;</span> +</span><br><span class="line">                                <span class="string">$&quot;\tpublic enum <span class="subst">&#123;enumNameStr&#125;</span>\r\n&quot;</span> +</span><br><span class="line">                                <span class="string">&quot;\t&#123;\r\n&quot;</span> +</span><br><span class="line">                                    <span class="string">$&quot;<span class="subst">&#123;fieldStr&#125;</span>&quot;</span> +</span><br><span class="line">                                <span class="string">&quot;\t&#125;\r\n&quot;</span> +</span><br><span class="line">                             <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">            <span class="comment">//保存文件的路径</span></span><br><span class="line">            <span class="built_in">string</span> path = SAVE_PATH + namespaceStr + <span class="string">&quot;/Enum/&quot;</span>;</span><br><span class="line">            <span class="comment">//如果不存在这个文件夹 则创建</span></span><br><span class="line">            <span class="keyword">if</span> (!Directory.Exists(path))</span><br><span class="line">                Directory.CreateDirectory(path);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//字符串保存 存储为枚举脚本文件</span></span><br><span class="line">            File.WriteAllText(path + enumNameStr + <span class="string">&quot;.cs&quot;</span>, enumStr);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Debug.Log(<span class="string">&quot;枚举生成结束&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//生成数据结构类</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GenerateData</span>(<span class="params">XmlNodeList nodes</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">string</span> namespaceStr = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="built_in">string</span> classNameStr = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="built_in">string</span> fieldStr = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="built_in">string</span> getBytesNumStr = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="built_in">string</span> writingStr = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="built_in">string</span> readingStr = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (XmlNode dataNode <span class="keyword">in</span> nodes)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//命名空间</span></span><br><span class="line">            namespaceStr = dataNode.Attributes[<span class="string">&quot;namespace&quot;</span>].Value;</span><br><span class="line">            <span class="comment">//类名</span></span><br><span class="line">            classNameStr = dataNode.Attributes[<span class="string">&quot;name&quot;</span>].Value;</span><br><span class="line">            <span class="comment">//读取所有字段节点</span></span><br><span class="line">            XmlNodeList fields = dataNode.SelectNodes(<span class="string">&quot;field&quot;</span>);</span><br><span class="line">            <span class="comment">//通过这个方法进行成员变量声明的拼接 返回拼接结果</span></span><br><span class="line">            fieldStr = GetFieldStr(fields);</span><br><span class="line">            <span class="comment">//通过某个方法 对GetBytesNum函数中的字符串内容进行拼接 返回结果</span></span><br><span class="line">            getBytesNumStr = GetGetBytesNumStr(fields);</span><br><span class="line">            <span class="comment">//通过某个方法 对Writing函数中的字符串内容进行拼接 返回结果</span></span><br><span class="line">            writingStr = GetWritingStr(fields);</span><br><span class="line">            <span class="comment">//通过某个方法 对Reading函数中的字符串内容进行拼接 返回结果</span></span><br><span class="line">            readingStr = GetReadingStr(fields);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">string</span> dataStr = <span class="string">&quot;using System;\r\n&quot;</span> +</span><br><span class="line">                             <span class="string">&quot;using System.Collections.Generic;\r\n&quot;</span> +</span><br><span class="line">                             <span class="string">&quot;using System.Text;\r\n&quot;</span> + </span><br><span class="line">                             <span class="string">$&quot;namespace <span class="subst">&#123;namespaceStr&#125;</span>\r\n&quot;</span> +</span><br><span class="line">                              <span class="string">&quot;&#123;\r\n&quot;</span> +</span><br><span class="line">                              <span class="string">$&quot;\tpublic class <span class="subst">&#123;classNameStr&#125;</span> : BaseData\r\n&quot;</span> +</span><br><span class="line">                              <span class="string">&quot;\t&#123;\r\n&quot;</span> +</span><br><span class="line">                                    <span class="string">$&quot;<span class="subst">&#123;fieldStr&#125;</span>&quot;</span> +</span><br><span class="line">                                    <span class="string">&quot;\t\tpublic override int GetBytesNum()\r\n&quot;</span> +</span><br><span class="line">                                    <span class="string">&quot;\t\t&#123;\r\n&quot;</span> +</span><br><span class="line">                                        <span class="string">&quot;\t\t\tint num = 0;\r\n&quot;</span> +</span><br><span class="line">                                        <span class="string">$&quot;<span class="subst">&#123;getBytesNumStr&#125;</span>&quot;</span> +</span><br><span class="line">                                        <span class="string">&quot;\t\t\treturn num;\r\n&quot;</span> +</span><br><span class="line">                                    <span class="string">&quot;\t\t&#125;\r\n&quot;</span> +</span><br><span class="line">                                    <span class="string">&quot;\t\tpublic override byte[] Writing()\r\n&quot;</span> +</span><br><span class="line">                                    <span class="string">&quot;\t\t&#123;\r\n&quot;</span> +</span><br><span class="line">                                        <span class="string">&quot;\t\t\tint index = 0;\r\n&quot;</span>+</span><br><span class="line">                                        <span class="string">&quot;\t\t\tbyte[] bytes = new byte[GetBytesNum()];\r\n&quot;</span> +</span><br><span class="line">                                        <span class="string">$&quot;<span class="subst">&#123;writingStr&#125;</span>&quot;</span> +</span><br><span class="line">                                        <span class="string">&quot;\t\t\treturn bytes;\r\n&quot;</span> +</span><br><span class="line">                                    <span class="string">&quot;\t\t&#125;\r\n&quot;</span> +</span><br><span class="line">                                    <span class="string">&quot;\t\tpublic override int Reading(byte[] bytes, int beginIndex = 0)\r\n&quot;</span> +</span><br><span class="line">                                    <span class="string">&quot;\t\t&#123;\r\n&quot;</span> +</span><br><span class="line">                                        <span class="string">&quot;\t\t\tint index = beginIndex;\r\n&quot;</span> +</span><br><span class="line">                                        <span class="string">$&quot;<span class="subst">&#123;readingStr&#125;</span>&quot;</span> +</span><br><span class="line">                                        <span class="string">&quot;\t\t\treturn index - beginIndex;\r\n&quot;</span> +</span><br><span class="line">                                    <span class="string">&quot;\t\t&#125;\r\n&quot;</span> +</span><br><span class="line">                              <span class="string">&quot;\t&#125;\r\n&quot;</span> +</span><br><span class="line">                              <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//保存为 脚本文件</span></span><br><span class="line">            <span class="comment">//保存文件的路径</span></span><br><span class="line">            <span class="built_in">string</span> path = SAVE_PATH + namespaceStr + <span class="string">&quot;/Data/&quot;</span>;</span><br><span class="line">            <span class="comment">//如果不存在这个文件夹 则创建</span></span><br><span class="line">            <span class="keyword">if</span> (!Directory.Exists(path))</span><br><span class="line">                Directory.CreateDirectory(path);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//字符串保存 存储为枚举脚本文件</span></span><br><span class="line">            File.WriteAllText(path + classNameStr + <span class="string">&quot;.cs&quot;</span>, dataStr);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        Debug.Log(<span class="string">&quot;数据结构类生成结束&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//生成消息类</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GenerateMsg</span>(<span class="params">XmlNodeList nodes</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">string</span> idStr = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="built_in">string</span> namespaceStr = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="built_in">string</span> classNameStr = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="built_in">string</span> fieldStr = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="built_in">string</span> getBytesNumStr = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="built_in">string</span> writingStr = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="built_in">string</span> readingStr = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (XmlNode dataNode <span class="keyword">in</span> nodes)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//消息ID</span></span><br><span class="line">            idStr = dataNode.Attributes[<span class="string">&quot;id&quot;</span>].Value;</span><br><span class="line">            <span class="comment">//命名空间</span></span><br><span class="line">            namespaceStr = dataNode.Attributes[<span class="string">&quot;namespace&quot;</span>].Value;</span><br><span class="line">            <span class="comment">//类名</span></span><br><span class="line">            classNameStr = dataNode.Attributes[<span class="string">&quot;name&quot;</span>].Value;</span><br><span class="line">            <span class="comment">//读取所有字段节点</span></span><br><span class="line">            XmlNodeList fields = dataNode.SelectNodes(<span class="string">&quot;field&quot;</span>);</span><br><span class="line">            <span class="comment">//通过这个方法进行成员变量声明的拼接 返回拼接结果</span></span><br><span class="line">            fieldStr = GetFieldStr(fields);</span><br><span class="line">            <span class="comment">//通过某个方法 对GetBytesNum函数中的字符串内容进行拼接 返回结果</span></span><br><span class="line">            getBytesNumStr = GetGetBytesNumStr(fields);</span><br><span class="line">            <span class="comment">//通过某个方法 对Writing函数中的字符串内容进行拼接 返回结果</span></span><br><span class="line">            writingStr = GetWritingStr(fields);</span><br><span class="line">            <span class="comment">//通过某个方法 对Reading函数中的字符串内容进行拼接 返回结果</span></span><br><span class="line">            readingStr = GetReadingStr(fields);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">string</span> dataStr = <span class="string">&quot;using System;\r\n&quot;</span> +</span><br><span class="line">                             <span class="string">&quot;using System.Collections.Generic;\r\n&quot;</span> +</span><br><span class="line">                             <span class="string">&quot;using System.Text;\r\n&quot;</span> +</span><br><span class="line">                             <span class="string">$&quot;namespace <span class="subst">&#123;namespaceStr&#125;</span>\r\n&quot;</span> +</span><br><span class="line">                              <span class="string">&quot;&#123;\r\n&quot;</span> +</span><br><span class="line">                              <span class="string">$&quot;\tpublic class <span class="subst">&#123;classNameStr&#125;</span> : BaseMsg\r\n&quot;</span> +</span><br><span class="line">                              <span class="string">&quot;\t&#123;\r\n&quot;</span> +</span><br><span class="line">                                    <span class="string">$&quot;<span class="subst">&#123;fieldStr&#125;</span>&quot;</span> +</span><br><span class="line">                                    <span class="string">&quot;\t\tpublic override int GetBytesNum()\r\n&quot;</span> +</span><br><span class="line">                                    <span class="string">&quot;\t\t&#123;\r\n&quot;</span> +</span><br><span class="line">                                        <span class="string">&quot;\t\t\tint num = 8;\r\n&quot;</span> +<span class="comment">//这个8代表的是 消息ID的4个字节 + 消息体长度的4个字节</span></span><br><span class="line">                                        <span class="string">$&quot;<span class="subst">&#123;getBytesNumStr&#125;</span>&quot;</span> +</span><br><span class="line">                                        <span class="string">&quot;\t\t\treturn num;\r\n&quot;</span> +</span><br><span class="line">                                    <span class="string">&quot;\t\t&#125;\r\n&quot;</span> +</span><br><span class="line">                                    <span class="string">&quot;\t\tpublic override byte[] Writing()\r\n&quot;</span> +</span><br><span class="line">                                    <span class="string">&quot;\t\t&#123;\r\n&quot;</span> +</span><br><span class="line">                                        <span class="string">&quot;\t\t\tint index = 0;\r\n&quot;</span> +</span><br><span class="line">                                        <span class="string">&quot;\t\t\tbyte[] bytes = new byte[GetBytesNum()];\r\n&quot;</span> +</span><br><span class="line">                                        <span class="string">&quot;\t\t\tWriteInt(bytes, GetID(), ref index);\r\n&quot;</span> +</span><br><span class="line">                                        <span class="string">&quot;\t\t\tWriteInt(bytes, bytes.Length - 8, ref index);\r\n&quot;</span> +</span><br><span class="line">                                        <span class="string">$&quot;<span class="subst">&#123;writingStr&#125;</span>&quot;</span> +</span><br><span class="line">                                        <span class="string">&quot;\t\t\treturn bytes;\r\n&quot;</span> +</span><br><span class="line">                                    <span class="string">&quot;\t\t&#125;\r\n&quot;</span> +</span><br><span class="line">                                    <span class="string">&quot;\t\tpublic override int Reading(byte[] bytes, int beginIndex = 0)\r\n&quot;</span> +</span><br><span class="line">                                    <span class="string">&quot;\t\t&#123;\r\n&quot;</span> +</span><br><span class="line">                                        <span class="string">&quot;\t\t\tint index = beginIndex;\r\n&quot;</span> +</span><br><span class="line">                                        <span class="string">$&quot;<span class="subst">&#123;readingStr&#125;</span>&quot;</span> +</span><br><span class="line">                                        <span class="string">&quot;\t\t\treturn index - beginIndex;\r\n&quot;</span> +</span><br><span class="line">                                    <span class="string">&quot;\t\t&#125;\r\n&quot;</span> +</span><br><span class="line">                                    <span class="string">&quot;\t\tpublic override int GetID()\r\n&quot;</span> +</span><br><span class="line">                                    <span class="string">&quot;\t\t&#123;\r\n&quot;</span> +</span><br><span class="line">                                        <span class="string">&quot;\t\t\treturn &quot;</span> + idStr + <span class="string">&quot;;\r\n&quot;</span> +</span><br><span class="line">                                    <span class="string">&quot;\t\t&#125;\r\n&quot;</span> +</span><br><span class="line">                              <span class="string">&quot;\t&#125;\r\n&quot;</span> +</span><br><span class="line">                              <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//保存为 脚本文件</span></span><br><span class="line">            <span class="comment">//保存文件的路径</span></span><br><span class="line">            <span class="built_in">string</span> path = SAVE_PATH + namespaceStr + <span class="string">&quot;/Msg/&quot;</span>;</span><br><span class="line">            <span class="comment">//如果不存在这个文件夹 则创建</span></span><br><span class="line">            <span class="keyword">if</span> (!Directory.Exists(path))</span><br><span class="line">                Directory.CreateDirectory(path);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//字符串保存 存储为枚举脚本文件</span></span><br><span class="line">            File.WriteAllText(path + classNameStr + <span class="string">&quot;.cs&quot;</span>, dataStr);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        Debug.Log(<span class="string">&quot;消息类生成结束&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取成员变量声明内容</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;fields&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">GetFieldStr</span>(<span class="params">XmlNodeList fields</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">string</span> fieldStr = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (XmlNode field <span class="keyword">in</span> fields)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//变量类型</span></span><br><span class="line">            <span class="built_in">string</span> type = field.Attributes[<span class="string">&quot;type&quot;</span>].Value;</span><br><span class="line">            <span class="comment">//变量名</span></span><br><span class="line">            <span class="built_in">string</span> fieldName = field.Attributes[<span class="string">&quot;name&quot;</span>].Value;</span><br><span class="line">            <span class="keyword">if</span>(type == <span class="string">&quot;list&quot;</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">string</span> T = field.Attributes[<span class="string">&quot;T&quot;</span>].Value;</span><br><span class="line">                fieldStr += <span class="string">&quot;\t\tpublic List&lt;&quot;</span> + T + <span class="string">&quot;&gt; &quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(type == <span class="string">&quot;array&quot;</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">string</span> data = field.Attributes[<span class="string">&quot;data&quot;</span>].Value;</span><br><span class="line">                fieldStr += <span class="string">&quot;\t\tpublic &quot;</span> + data + <span class="string">&quot;[] &quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(type == <span class="string">&quot;dic&quot;</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">string</span> Tkey = field.Attributes[<span class="string">&quot;Tkey&quot;</span>].Value;</span><br><span class="line">                <span class="built_in">string</span> Tvalue = field.Attributes[<span class="string">&quot;Tvalue&quot;</span>].Value;</span><br><span class="line">                fieldStr += <span class="string">&quot;\t\tpublic Dictionary&lt;&quot;</span> + Tkey +  <span class="string">&quot;, &quot;</span> + Tvalue + <span class="string">&quot;&gt; &quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(type == <span class="string">&quot;enum&quot;</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">string</span> data = field.Attributes[<span class="string">&quot;data&quot;</span>].Value;</span><br><span class="line">                fieldStr += <span class="string">&quot;\t\tpublic &quot;</span> + data + <span class="string">&quot; &quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                fieldStr += <span class="string">&quot;\t\tpublic &quot;</span> + type + <span class="string">&quot; &quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            fieldStr += fieldName + <span class="string">&quot;;\r\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> fieldStr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//拼接 GetBytesNum函数的方法</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">GetGetBytesNumStr</span>(<span class="params">XmlNodeList fields</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">string</span> bytesNumStr = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">string</span> type = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="built_in">string</span> name = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (XmlNode field <span class="keyword">in</span> fields)</span><br><span class="line">        &#123;</span><br><span class="line">            type = field.Attributes[<span class="string">&quot;type&quot;</span>].Value;</span><br><span class="line">            name = field.Attributes[<span class="string">&quot;name&quot;</span>].Value;</span><br><span class="line">            <span class="keyword">if</span> (type == <span class="string">&quot;list&quot;</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">string</span> T = field.Attributes[<span class="string">&quot;T&quot;</span>].Value;</span><br><span class="line">                bytesNumStr += <span class="string">&quot;\t\t\tnum += 2;\r\n&quot;</span>;<span class="comment">//+2 是为了节约字节数 用一个short去存储信息</span></span><br><span class="line">                bytesNumStr += <span class="string">&quot;\t\t\tfor (int i = 0; i &lt; &quot;</span> + name + <span class="string">&quot;.Count; ++i)\r\n&quot;</span>;</span><br><span class="line">                <span class="comment">//这里使用的是 name + [i] 目的是获取 list当中的元素传入进行使用</span></span><br><span class="line">                bytesNumStr += <span class="string">&quot;\t\t\t\tnum += &quot;</span> + GetValueBytesNum(T, name + <span class="string">&quot;[i]&quot;</span>) + <span class="string">&quot;;\r\n&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (type == <span class="string">&quot;array&quot;</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">string</span> data = field.Attributes[<span class="string">&quot;data&quot;</span>].Value;</span><br><span class="line">                bytesNumStr += <span class="string">&quot;\t\t\tnum += 2;\r\n&quot;</span>;<span class="comment">//+2 是为了节约字节数 用一个short去存储信息</span></span><br><span class="line">                bytesNumStr += <span class="string">&quot;\t\t\tfor (int i = 0; i &lt; &quot;</span> + name + <span class="string">&quot;.Length; ++i)\r\n&quot;</span>;</span><br><span class="line">                <span class="comment">//这里使用的是 name + [i] 目的是获取 list当中的元素传入进行使用</span></span><br><span class="line">                bytesNumStr += <span class="string">&quot;\t\t\t\tnum += &quot;</span> + GetValueBytesNum(data, name + <span class="string">&quot;[i]&quot;</span>) + <span class="string">&quot;;\r\n&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (type == <span class="string">&quot;dic&quot;</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">string</span> Tkey = field.Attributes[<span class="string">&quot;Tkey&quot;</span>].Value;</span><br><span class="line">                <span class="built_in">string</span> Tvalue = field.Attributes[<span class="string">&quot;Tvalue&quot;</span>].Value;</span><br><span class="line">                bytesNumStr += <span class="string">&quot;\t\t\tnum += 2;\r\n&quot;</span>;<span class="comment">//+2 是为了节约字节数 用一个short去存储信息</span></span><br><span class="line">                bytesNumStr += <span class="string">&quot;\t\t\tforeach (&quot;</span> + Tkey + <span class="string">&quot; key in &quot;</span> + name + <span class="string">&quot;.Keys)\r\n&quot;</span>;</span><br><span class="line">                bytesNumStr += <span class="string">&quot;\t\t\t&#123;\r\n&quot;</span>;</span><br><span class="line">                bytesNumStr += <span class="string">&quot;\t\t\t\tnum += &quot;</span> + GetValueBytesNum(Tkey, <span class="string">&quot;key&quot;</span>) + <span class="string">&quot;;\r\n&quot;</span>;</span><br><span class="line">                bytesNumStr += <span class="string">&quot;\t\t\t\tnum += &quot;</span> + GetValueBytesNum(Tvalue, name + <span class="string">&quot;[key]&quot;</span>) + <span class="string">&quot;;\r\n&quot;</span>;</span><br><span class="line">                bytesNumStr += <span class="string">&quot;\t\t\t&#125;\r\n&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                bytesNumStr += <span class="string">&quot;\t\t\tnum += &quot;</span> + GetValueBytesNum(type, name) + <span class="string">&quot;;\r\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> bytesNumStr;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//获取 指定类型的字节数</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">GetValueBytesNum</span>(<span class="params"><span class="built_in">string</span> type, <span class="built_in">string</span> name</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//这里我没有写全 所有的常用变量类型 你可以根据需求去添加</span></span><br><span class="line">        <span class="keyword">switch</span> (type)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;int&quot;</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;float&quot;</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;enum&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;4&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;long&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;8&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;byte&quot;</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;bool&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;1&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;short&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;2&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;string&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;4 + Encoding.UTF8.GetByteCount(&quot;</span> + name + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">            <span class="literal">default</span>:</span><br><span class="line">                <span class="keyword">return</span> name + <span class="string">&quot;.GetBytesNum()&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//拼接 Writing函数的方法</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">GetWritingStr</span>(<span class="params">XmlNodeList fields</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">string</span> writingStr = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">string</span> type = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="built_in">string</span> name = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (XmlNode field <span class="keyword">in</span> fields)</span><br><span class="line">        &#123;</span><br><span class="line">            type = field.Attributes[<span class="string">&quot;type&quot;</span>].Value;</span><br><span class="line">            name = field.Attributes[<span class="string">&quot;name&quot;</span>].Value;</span><br><span class="line">            <span class="keyword">if</span>(type == <span class="string">&quot;list&quot;</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">string</span> T = field.Attributes[<span class="string">&quot;T&quot;</span>].Value;</span><br><span class="line">                writingStr += <span class="string">&quot;\t\t\tWriteShort(bytes, (short)&quot;</span> + name + <span class="string">&quot;.Count, ref index);\r\n&quot;</span>;</span><br><span class="line">                writingStr += <span class="string">&quot;\t\t\tfor (int i = 0; i &lt; &quot;</span> + name + <span class="string">&quot;.Count; ++i)\r\n&quot;</span>;</span><br><span class="line">                writingStr += <span class="string">&quot;\t\t\t\t&quot;</span> + GetFieldWritingStr(T, name + <span class="string">&quot;[i]&quot;</span>) + <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (type == <span class="string">&quot;array&quot;</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">string</span> data = field.Attributes[<span class="string">&quot;data&quot;</span>].Value;</span><br><span class="line">                writingStr += <span class="string">&quot;\t\t\tWriteShort(bytes, (short)&quot;</span> + name + <span class="string">&quot;.Length, ref index);\r\n&quot;</span>;</span><br><span class="line">                writingStr += <span class="string">&quot;\t\t\tfor (int i = 0; i &lt; &quot;</span> + name + <span class="string">&quot;.Length; ++i)\r\n&quot;</span>;</span><br><span class="line">                writingStr += <span class="string">&quot;\t\t\t\t&quot;</span> + GetFieldWritingStr(data, name + <span class="string">&quot;[i]&quot;</span>) + <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (type == <span class="string">&quot;dic&quot;</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">string</span> Tkey = field.Attributes[<span class="string">&quot;Tkey&quot;</span>].Value;</span><br><span class="line">                <span class="built_in">string</span> Tvalue = field.Attributes[<span class="string">&quot;Tvalue&quot;</span>].Value;</span><br><span class="line">                writingStr += <span class="string">&quot;\t\t\tWriteShort(bytes, (short)&quot;</span> + name + <span class="string">&quot;.Count, ref index);\r\n&quot;</span>;</span><br><span class="line">                writingStr += <span class="string">&quot;\t\t\tforeach (&quot;</span> + Tkey + <span class="string">&quot; key in &quot;</span> + name + <span class="string">&quot;.Keys)\r\n&quot;</span>;</span><br><span class="line">                writingStr += <span class="string">&quot;\t\t\t&#123;\r\n&quot;</span>;</span><br><span class="line">                writingStr += <span class="string">&quot;\t\t\t\t&quot;</span> + GetFieldWritingStr(Tkey, <span class="string">&quot;key&quot;</span>) + <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">                writingStr += <span class="string">&quot;\t\t\t\t&quot;</span> + GetFieldWritingStr(Tvalue, name + <span class="string">&quot;[key]&quot;</span>) + <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">                writingStr += <span class="string">&quot;\t\t\t&#125;\r\n&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                writingStr += <span class="string">&quot;\t\t\t&quot;</span> + GetFieldWritingStr(type, name) + <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> writingStr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">GetFieldWritingStr</span>(<span class="params"><span class="built_in">string</span> type, <span class="built_in">string</span> name</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">switch</span> (type)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;byte&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;WriteByte(bytes, &quot;</span> + name + <span class="string">&quot;, ref index);&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;int&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;WriteInt(bytes, &quot;</span> + name + <span class="string">&quot;, ref index);&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;short&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;WriteShort(bytes, &quot;</span> + name + <span class="string">&quot;, ref index);&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;long&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;WriteLong(bytes, &quot;</span> + name + <span class="string">&quot;, ref index);&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;float&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;WriteFloat(bytes, &quot;</span> + name + <span class="string">&quot;, ref index);&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;bool&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;WriteBool(bytes, &quot;</span> + name + <span class="string">&quot;, ref index);&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;string&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;WriteString(bytes, &quot;</span> + name + <span class="string">&quot;, ref index);&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;enum&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;WriteInt(bytes, Convert.ToInt32(&quot;</span> + name + <span class="string">&quot;), ref index);&quot;</span>;</span><br><span class="line">            <span class="literal">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;WriteData(bytes, &quot;</span> + name + <span class="string">&quot;, ref index);&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">GetReadingStr</span>(<span class="params">XmlNodeList fields</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">string</span> readingStr = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">string</span> type = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="built_in">string</span> name = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (XmlNode field <span class="keyword">in</span> fields)</span><br><span class="line">        &#123;</span><br><span class="line">            type = field.Attributes[<span class="string">&quot;type&quot;</span>].Value;</span><br><span class="line">            name = field.Attributes[<span class="string">&quot;name&quot;</span>].Value;</span><br><span class="line">            <span class="keyword">if</span> (type == <span class="string">&quot;list&quot;</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">string</span> T = field.Attributes[<span class="string">&quot;T&quot;</span>].Value;</span><br><span class="line">                readingStr += <span class="string">&quot;\t\t\t&quot;</span> + name + <span class="string">&quot; = new List&lt;&quot;</span> + T + <span class="string">&quot;&gt;();\r\n&quot;</span>;</span><br><span class="line">                readingStr += <span class="string">&quot;\t\t\tshort &quot;</span> + name + <span class="string">&quot;Count = ReadShort(bytes, ref index);\r\n&quot;</span>;</span><br><span class="line">                readingStr += <span class="string">&quot;\t\t\tfor (int i = 0; i &lt; &quot;</span> + name + <span class="string">&quot;Count; ++i)\r\n&quot;</span>;</span><br><span class="line">                readingStr += <span class="string">&quot;\t\t\t\t&quot;</span> + name + <span class="string">&quot;.Add(&quot;</span> + GetFieldReadingStr(T) + <span class="string">&quot;);\r\n&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (type == <span class="string">&quot;array&quot;</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">string</span> data = field.Attributes[<span class="string">&quot;data&quot;</span>].Value;</span><br><span class="line">                readingStr += <span class="string">&quot;\t\t\tshort &quot;</span> + name + <span class="string">&quot;Length = ReadShort(bytes, ref index);\r\n&quot;</span>;</span><br><span class="line">                readingStr += <span class="string">&quot;\t\t\t&quot;</span> + name + <span class="string">&quot; = new &quot;</span> + data + <span class="string">&quot;[&quot;</span>+ name + <span class="string">&quot;Length];\r\n&quot;</span>;</span><br><span class="line">                readingStr += <span class="string">&quot;\t\t\tfor (int i = 0; i &lt; &quot;</span> + name + <span class="string">&quot;Length; ++i)\r\n&quot;</span>;</span><br><span class="line">                readingStr += <span class="string">&quot;\t\t\t\t&quot;</span> + name + <span class="string">&quot;[i] = &quot;</span> + GetFieldReadingStr(data) + <span class="string">&quot;;\r\n&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (type == <span class="string">&quot;dic&quot;</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">string</span> Tkey = field.Attributes[<span class="string">&quot;Tkey&quot;</span>].Value;</span><br><span class="line">                <span class="built_in">string</span> Tvalue = field.Attributes[<span class="string">&quot;Tvalue&quot;</span>].Value;</span><br><span class="line">                readingStr += <span class="string">&quot;\t\t\t&quot;</span> + name + <span class="string">&quot; = new Dictionary&lt;&quot;</span> + Tkey + <span class="string">&quot;, &quot;</span> + Tvalue + <span class="string">&quot;&gt;();\r\n&quot;</span>;</span><br><span class="line">                readingStr += <span class="string">&quot;\t\t\tshort &quot;</span> + name + <span class="string">&quot;Count = ReadShort(bytes, ref index);\r\n&quot;</span>;</span><br><span class="line">                readingStr += <span class="string">&quot;\t\t\tfor (int i = 0; i &lt; &quot;</span> + name + <span class="string">&quot;Count; ++i)\r\n&quot;</span>;</span><br><span class="line">                readingStr += <span class="string">&quot;\t\t\t\t&quot;</span> + name + <span class="string">&quot;.Add(&quot;</span> + GetFieldReadingStr(Tkey) + <span class="string">&quot;, &quot;</span> +</span><br><span class="line">                                                            GetFieldReadingStr(Tvalue) + <span class="string">&quot;);\r\n&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (type == <span class="string">&quot;enum&quot;</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">string</span> data = field.Attributes[<span class="string">&quot;data&quot;</span>].Value;</span><br><span class="line">                readingStr += <span class="string">&quot;\t\t\t&quot;</span> + name + <span class="string">&quot; = (&quot;</span> + data + <span class="string">&quot;)ReadInt(bytes, ref index);\r\n&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                readingStr += <span class="string">&quot;\t\t\t&quot;</span> + name + <span class="string">&quot; = &quot;</span> + GetFieldReadingStr(type) + <span class="string">&quot;;\r\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> readingStr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">GetFieldReadingStr</span>(<span class="params"><span class="built_in">string</span> type</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">switch</span> (type)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;byte&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;ReadByte(bytes, ref index)&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;int&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;ReadInt(bytes, ref index)&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;short&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;ReadShort(bytes, ref index)&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;long&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;ReadLong(bytes, ref index)&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;float&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;ReadFloat(bytes, ref index)&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;bool&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;ReadBool(bytes, ref index)&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;string&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;ReadString(bytes, ref index)&quot;</span>;</span><br><span class="line">            <span class="literal">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;ReadData&lt;&quot;</span> + type + <span class="string">&quot;&gt;(bytes, ref index)&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="Protobuf"><a href="#Protobuf" class="headerlink" title="Protobuf"></a>Protobuf</h1><h2 id="协议编写规则"><a href="#协议编写规则" class="headerlink" title="协议编写规则"></a>协议编写规则</h2><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;<span class="comment">//决定了proto文档的版本号</span></span><br><span class="line"><span class="comment">//规则二：版本号</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//规则一：注释方式</span></span><br><span class="line"><span class="comment">//注释方式一</span></span><br><span class="line"><span class="comment">/*注释方式二*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//规则11：导入定义</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;test2.proto&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//规则三：命名空间</span></span><br><span class="line"><span class="keyword">package</span> GamePlayerTest;<span class="comment">//这决定了命名空间</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//规则四：消息类</span></span><br><span class="line"><span class="keyword">message </span><span class="title class_">TestMsg</span>&#123;</span><br><span class="line">	<span class="comment">//规则五：成员类型 和 唯一编号</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//浮点数</span></span><br><span class="line">	<span class="comment">// = 1 不代表默认值 而是代表唯一编号 方便我们进行序列化和反序列化的处理</span></span><br><span class="line">	<span class="comment">//required 必须赋值的字段</span></span><br><span class="line">	<span class="keyword">required</span> <span class="type">float</span> testF = <span class="number">1</span>; <span class="comment">//C# - float</span></span><br><span class="line">	<span class="comment">//optional 可以不赋值的字段</span></span><br><span class="line">	<span class="keyword">optional</span> <span class="type">double</span> testD = <span class="number">2</span>; <span class="comment">//C# - double</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//变长编码</span></span><br><span class="line">	<span class="comment">//所谓变长 就是会根据 数字的大小 来使用对应的字节数来存储  1 2 4 </span></span><br><span class="line">	<span class="comment">//Protobuf帮助我们优化的部分 可以尽量少的使用字节数 来存储内容</span></span><br><span class="line">	<span class="type">int32</span> testInt32 = <span class="number">3</span>; <span class="comment">//C# - int 它不太适用于来表示负数 请使用sint32</span></span><br><span class="line">	<span class="comment">//1 2 4 8</span></span><br><span class="line">	<span class="type">int64</span> testInt64 = <span class="number">4</span>; <span class="comment">//C# - long  它不太适用于来表示负数 请使用sint64</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//更实用与表示负数类型的整数</span></span><br><span class="line">	<span class="type">sint32</span> testSInt32 = <span class="number">5</span>; <span class="comment">//C# - int 适用于来表示负数的整数</span></span><br><span class="line">	<span class="type">sint64</span> testSInt64 = <span class="number">6</span>; <span class="comment">//C# - long 适用于来表示负数的整数</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//无符号 变长编码</span></span><br><span class="line">	<span class="comment">//1 2 4</span></span><br><span class="line">	<span class="type">uint32</span> testUInt = <span class="number">7</span>; <span class="comment">//C# - uint 变长的编码</span></span><br><span class="line">	<span class="type">uint64</span> testULong = <span class="number">8</span>; <span class="comment">//C# - ulong 变长的编码</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//固定字节数的类型</span></span><br><span class="line">	<span class="type">fixed32</span> testFixed32 = <span class="number">9</span>; <span class="comment">//C# -uint 它通常用来表示大于2的28次方的数 ，比uint32更有效 始终是4个字节</span></span><br><span class="line">	<span class="type">fixed64</span> testFixed64 = <span class="number">10</span>; <span class="comment">//C# -ulong 它通常用来表示大于2的56次方的数 ，比uint64更有效 始终是8个字节</span></span><br><span class="line"></span><br><span class="line">	<span class="type">sfixed32</span> testSFixed32 = <span class="number">11</span>; <span class="comment">//C# - int 始终4个字节</span></span><br><span class="line">	<span class="type">sfixed64</span> testSFixed64 = <span class="number">12</span>; <span class="comment">//C# - long 始终8个字节</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//其它类型</span></span><br><span class="line">	<span class="type">bool</span> testBool = <span class="number">13</span>; <span class="comment">//C# - bool </span></span><br><span class="line">	<span class="type">string</span> testStr = <span class="number">14</span>; <span class="comment">//C# - string</span></span><br><span class="line">	<span class="type">bytes</span> testBytes = <span class="number">15</span>; <span class="comment">//C# - BytesString 字节字符串</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//数组List</span></span><br><span class="line">	<span class="keyword">repeated</span> <span class="type">int32</span> listInt = <span class="number">16</span>; <span class="comment">// C# - 类似List&lt;int&gt;的使用</span></span><br><span class="line">	<span class="comment">//字典Dictionary</span></span><br><span class="line">	map&lt;<span class="type">int32</span>, <span class="type">string</span>&gt; testMap = <span class="number">17</span>; <span class="comment">// C# - 类似Dictionary&lt;int, string&gt; 的使用</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//枚举成员变量的声明 需要唯一编码</span></span><br><span class="line">	TestEnum testEnum = <span class="number">18</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//声明自定义类对象 需要唯一编码</span></span><br><span class="line">	<span class="comment">//默认值是null</span></span><br><span class="line">	TestMsg2 testMsg2 = <span class="number">19</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//规则9：允许嵌套</span></span><br><span class="line">	<span class="comment">//嵌套一个类在另一个类当中 相当于是内部类</span></span><br><span class="line">	<span class="keyword">message </span><span class="title class_">TestMsg3</span>&#123;</span><br><span class="line">		<span class="type">int32</span> testInt32 = <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	TestMsg3 testMsg3 = <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//规则9：允许嵌套</span></span><br><span class="line">	<span class="keyword">enum </span><span class="title class_">TestEnum2</span>&#123;</span><br><span class="line">		NORMAL = <span class="number">0</span>; <span class="comment">//第一个常量必须映射到0</span></span><br><span class="line">		BOSS = <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	TestEnum2 testEnum2 = <span class="number">21</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//int32 testInt3233333 = 22;</span></span><br><span class="line"></span><br><span class="line">	<span class="type">bool</span> testBool2123123 = <span class="number">23</span>;</span><br><span class="line"></span><br><span class="line">	GameSystemTest.HeartMsg testHeart = <span class="number">24</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//告诉编译器 22 被占用 不准用户使用</span></span><br><span class="line">	<span class="comment">//之所以有这个功能 是为了在版本不匹配时 反序列化时 不会出现结构不统一</span></span><br><span class="line">	<span class="comment">//解析错误的问题</span></span><br><span class="line">	reserved <span class="number">22</span>;</span><br><span class="line">	reserved testInt3233333;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//枚举的声明</span></span><br><span class="line"><span class="keyword">enum </span><span class="title class_">TestEnum</span>&#123;</span><br><span class="line">	NORMAL = <span class="number">0</span>; <span class="comment">//第一个常量必须映射到0</span></span><br><span class="line">	BOSS = <span class="number">5</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">TestMsg2</span>&#123;</span><br><span class="line">	<span class="type">int32</span> testInt32 = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="协议生成"><a href="#协议生成" class="headerlink" title="协议生成"></a>协议生成</h2><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">要使用Protocol Buffers（protobuf）生成C<span class="comment">#代码，可以使用以下命令行命令：</span></span><br><span class="line"></span><br><span class="line">protoc -I=&lt;proto文件目录&gt; --csharp_out=&lt;输出目录&gt; &lt;proto文件路径&gt;</span><br><span class="line"></span><br><span class="line">其中，需要替换以下内容：</span><br><span class="line"></span><br><span class="line">&lt;proto文件目录&gt;：proto文件所在的目录路径。</span><br><span class="line">&lt;输出目录&gt;：生成的C<span class="comment">#代码的输出目录路径。</span></span><br><span class="line">&lt;proto文件路径&gt;：要生成代码的proto文件路径。</span><br><span class="line">例如，假设你有一个名为<span class="keyword">message</span>.proto的proto文件，它位于D:\ProtoFiles目录中，并且你想将生成的C<span class="comment">#代码输出到D:\GeneratedCode目录中。那么你可以使用以下命令：</span></span><br><span class="line"></span><br><span class="line">protoc -I=D:\ProtoFiles --csharp_out=D:\GeneratedCode D:\ProtoFiles\<span class="keyword">message</span>.proto</span><br><span class="line"></span><br><span class="line">执行此命令后，会在指定的输出目录中生成相应的C<span class="comment">#代码文件，用于在C#项目中使用Protocol Buffers。</span></span><br><span class="line"></span><br><span class="line">请确保在执行命令之前已经安装了Protocol Buffers的编译器（protoc）并将其添加到系统的环境变量中，以便在命令行中能够直接调用该命令。</span><br><span class="line">pause</span><br></pre></td></tr></table></figure>

<h2 id="数据的序列化和反序列化"><a href="#数据的序列化和反序列化" class="headerlink" title="数据的序列化和反序列化"></a>数据的序列化和反序列化</h2><h3 id="存入读取文件和内存流"><a href="#存入读取文件和内存流" class="headerlink" title="存入读取文件和内存流"></a>存入读取文件和内存流</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> GamePlayerTest;</span><br><span class="line"><span class="keyword">using</span> Google.Protobuf;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Lesson41</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Start is called before the first frame update</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 知识点一 序列化存储为本地文件</span></span><br><span class="line">        <span class="comment">//主要使用</span></span><br><span class="line">        <span class="comment">//1.生成的类中的 WriteTo方法</span></span><br><span class="line">        <span class="comment">//2.文件流FileStream对象</span></span><br><span class="line">        TestMsg msg = <span class="keyword">new</span> TestMsg();</span><br><span class="line">        msg.ListInt.Add(<span class="number">1</span>);</span><br><span class="line">        msg.TestBool = <span class="literal">false</span>;</span><br><span class="line">        msg.TestD = <span class="number">5.5</span>;</span><br><span class="line">        msg.TestInt32 = <span class="number">99</span>;</span><br><span class="line">        msg.TestMap.Add(<span class="number">1</span>, <span class="string">&quot;唐老狮&quot;</span>);</span><br><span class="line">        msg.TestMsg2 = <span class="keyword">new</span> TestMsg2();</span><br><span class="line">        msg.TestMsg2.TestInt32 = <span class="number">88</span>;</span><br><span class="line">        msg.TestMsg3 = <span class="keyword">new</span> TestMsg.Types.TestMsg3();</span><br><span class="line">        msg.TestMsg3.TestInt32 = <span class="number">66</span>;</span><br><span class="line"></span><br><span class="line">        msg.TestHeart = <span class="keyword">new</span> GameSystemTest.HeartMsg();</span><br><span class="line">        msg.TestHeart.Time = <span class="number">7777</span>;</span><br><span class="line"></span><br><span class="line">        print(Application.persistentDataPath);</span><br><span class="line">        <span class="keyword">using</span> (FileStream fs = File.Create(Application.persistentDataPath + <span class="string">&quot;/TestMsg.tang&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            msg.WriteTo(fs);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 知识点二 反序列化本地文件</span></span><br><span class="line">        <span class="comment">//主要使用</span></span><br><span class="line">        <span class="comment">//1.生成的类中的 Parser.ParseFrom方法</span></span><br><span class="line">        <span class="comment">//2.文件流FileStream对象</span></span><br><span class="line">        <span class="keyword">using</span> (FileStream fs = File.OpenRead(Application.persistentDataPath + <span class="string">&quot;/TestMsg.tang&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            TestMsg msg2 = <span class="literal">null</span>;</span><br><span class="line">            msg2 = TestMsg.Parser.ParseFrom(fs);</span><br><span class="line">            print(msg2.TestMap[<span class="number">1</span>]);</span><br><span class="line">            print(msg2.ListInt[<span class="number">0</span>]);</span><br><span class="line">            print(msg2.TestD);</span><br><span class="line">            print(msg2.TestMsg2.TestInt32);</span><br><span class="line">            print(msg2.TestMsg3.TestInt32);</span><br><span class="line">            print(msg2.TestHeart.Time);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 知识点三 得到序列化后的字节数组</span></span><br><span class="line">        <span class="comment">//主要使用</span></span><br><span class="line">        <span class="comment">//1.生成的类中的 WriteTo方法</span></span><br><span class="line">        <span class="comment">//2.内存流MemoryStream对象</span></span><br><span class="line">        <span class="built_in">byte</span>[] bytes = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">using</span> (MemoryStream ms = <span class="keyword">new</span> MemoryStream())</span><br><span class="line">        &#123;</span><br><span class="line">            msg.WriteTo(ms);</span><br><span class="line">            bytes = ms.ToArray();</span><br><span class="line">            print(<span class="string">&quot;字节数组长度&quot;</span> + bytes.Length);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 知识点四 从字节数组反序列化</span></span><br><span class="line">        <span class="comment">//主要使用</span></span><br><span class="line">        <span class="comment">//1.生成的类中的 Parser.ParseFrom方法</span></span><br><span class="line">        <span class="comment">//2.内存流MemoryStream对象</span></span><br><span class="line">        <span class="keyword">using</span> (MemoryStream ms = <span class="keyword">new</span> MemoryStream(bytes))</span><br><span class="line">        &#123;</span><br><span class="line">            print(<span class="string">&quot;内存流当中反序列化的内容&quot;</span>);</span><br><span class="line">            TestMsg msg2 = TestMsg.Parser.ParseFrom(ms);</span><br><span class="line">            print(msg2.TestMap[<span class="number">1</span>]);</span><br><span class="line">            print(msg2.ListInt[<span class="number">0</span>]);</span><br><span class="line">            print(msg2.TestD);</span><br><span class="line">            print(msg2.TestMsg2.TestInt32);</span><br><span class="line">            print(msg2.TestMsg3.TestInt32);</span><br><span class="line">            print(msg2.TestHeart.Time);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 总结</span></span><br><span class="line">        <span class="comment">//Protobuf的 序列化和反序列化都要通过</span></span><br><span class="line">        <span class="comment">//流对象来进行处理</span></span><br><span class="line">        <span class="comment">//如果是进行本地存储 则可以使用文件流</span></span><br><span class="line">        <span class="comment">//如果是进行网络传输 则可以使用内存流获取字节数组</span></span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update is called once per frame</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="NetTool（直接序列化反序列化）"><a href="#NetTool（直接序列化反序列化）" class="headerlink" title="NetTool（直接序列化反序列化）"></a>NetTool（直接序列化反序列化）</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Google.Protobuf;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">NetTool</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//序列化Protobuf生成的对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">byte</span>[] <span class="title">GetProtoBytes</span>(<span class="params"> IMessage msg </span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//拓展方法、里氏替换、接口 这些知识点 都在 C#相关的内容当中</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//基础写法 基于上节课学习的知识点</span></span><br><span class="line">        <span class="comment">//byte[] bytes = null;</span></span><br><span class="line">        <span class="comment">//using (MemoryStream ms = new MemoryStream())</span></span><br><span class="line">        <span class="comment">//&#123;</span></span><br><span class="line">        <span class="comment">//    msg.WriteTo(ms);</span></span><br><span class="line">        <span class="comment">//    bytes = ms.ToArray();</span></span><br><span class="line">        <span class="comment">//&#125;</span></span><br><span class="line">        <span class="comment">//return bytes;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//通过该拓展方法 就可以直接获取对应对象的 字节数组了</span></span><br><span class="line">        <span class="keyword">return</span> msg.ToByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 反序列化字节数组为Protobuf相关的对象</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>想要获取的消息类型<span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;bytes&quot;&gt;</span>对应的字节数组 用于反序列化<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> T <span class="title">GetProtoMsg</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">byte</span>[] bytes</span>) <span class="keyword">where</span> T:<span class="keyword">class</span>, IMessage</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//泛型 C#进阶</span></span><br><span class="line">        <span class="comment">//反射 C#进阶</span></span><br><span class="line">        <span class="comment">//得到对应消息的类型 通过反射得到内部的静态成员 然后得到其中的 对应方法</span></span><br><span class="line">        <span class="comment">//进行反序列化</span></span><br><span class="line">        Type type = <span class="keyword">typeof</span>(T);</span><br><span class="line">        <span class="comment">//通过反射 得到对应的 静态成员属性对象</span></span><br><span class="line">        PropertyInfo pInfo = type.GetProperty(<span class="string">&quot;Parser&quot;</span>);</span><br><span class="line">        <span class="built_in">object</span> parserObj = pInfo.GetValue(<span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//已经得到了对象 那么可以得到该对象中的 对应方法 </span></span><br><span class="line">        Type parserType = parserObj.GetType();</span><br><span class="line">        <span class="comment">//这是指定得到某一个重载函数</span></span><br><span class="line">        MethodInfo mInfo = parserType.GetMethod(<span class="string">&quot;ParseFrom&quot;</span>, <span class="keyword">new</span> Type[] &#123; <span class="keyword">typeof</span>(<span class="built_in">byte</span>[]) &#125;);</span><br><span class="line">        <span class="comment">//调用对应的方法 反序列化为指定的对象</span></span><br><span class="line">        <span class="built_in">object</span> msg = mInfo.Invoke(parserObj, <span class="keyword">new</span> <span class="built_in">object</span>[] &#123; bytes &#125;);</span><br><span class="line">        <span class="keyword">return</span> msg <span class="keyword">as</span> T;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="消息处理"><a href="#消息处理" class="headerlink" title="消息处理"></a>消息处理</h1><h2 id="大小端模式"><a href="#大小端模式" class="headerlink" title="大小端模式"></a>大小端模式</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Lesson43</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Start is called before the first frame update</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 知识点一 什么是大小端模式</span></span><br><span class="line">        <span class="comment">//大端模式</span></span><br><span class="line">        <span class="comment">//是指数据的高字节保存在内存的低地址中</span></span><br><span class="line">        <span class="comment">//而数据的低字节保存在内存的高地址中</span></span><br><span class="line">        <span class="comment">//这样的存储模式有点儿类似于把数据当作字符串顺序处理</span></span><br><span class="line">        <span class="comment">//地址由小向大增加，数据从高位往低位放</span></span><br><span class="line">        <span class="comment">//符合人类的阅读习惯</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//小端模式</span></span><br><span class="line">        <span class="comment">//是指数据的高字节保存在内存的高地址中</span></span><br><span class="line">        <span class="comment">//而数据的低字节保存在内存的低地址中</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//举例说明</span></span><br><span class="line">        <span class="comment">//十六进制数据0x11223344</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//大端模式存储</span></span><br><span class="line">        <span class="comment">// 11    22    33    44</span></span><br><span class="line">        <span class="comment">// 0     1     2     3</span></span><br><span class="line">        <span class="comment">//低地址——&gt;高地址</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//小端模式存储</span></span><br><span class="line">        <span class="comment">// 44    33    22    11</span></span><br><span class="line">        <span class="comment">// 0     1     2     3</span></span><br><span class="line">        <span class="comment">//低地址——&gt;高地址</span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 知识点二 为什么有大小端模式</span></span><br><span class="line">        <span class="comment">//大小端模式其实是计算机硬件的两种存储数据的方式</span></span><br><span class="line">        <span class="comment">//我们也可以称大小端模式为 大小端字节序</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//对于我们来说，大端字节序阅读起来更加方便，为什么还要有小端字节序呢？</span></span><br><span class="line">        <span class="comment">//原因是，计算机电路先处理低位字节，效率比较高</span></span><br><span class="line">        <span class="comment">//计算机处理字节序的时候，不知道什么是高位字节，什么是低位字节</span></span><br><span class="line">        <span class="comment">//它只知道按顺序读取字节，先读第一个字节，再读第二个字节</span></span><br><span class="line">        <span class="comment">//如果是大端字节序，先读到的就是高位字节，后读到的就是低位字节</span></span><br><span class="line">        <span class="comment">//小端字节序正好相反</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//因为计算机都是从低位开始的</span></span><br><span class="line">        <span class="comment">//所以，计算机的内部处理都是小端字节序</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//但是，我们人类的读写习惯还是大端字节序</span></span><br><span class="line">        <span class="comment">//所以，除了计算机的内部处理</span></span><br><span class="line">        <span class="comment">//其它场合几乎都是大端字节序，比如网络传输和文件存储</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//一般情况下，操作系统都是小端模式，而通讯协议都是大端模式</span></span><br><span class="line">        <span class="comment">//但是具体的模式，还是要根据硬件平台，开发语言来决定</span></span><br><span class="line">        <span class="comment">//主机不同，开发语言不同 可能采用的大小端模式也会不一致</span></span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 知识点三 大小端模式对于我们的影响</span></span><br><span class="line">        <span class="comment">//我们记住一句话：</span></span><br><span class="line">        <span class="comment">//只有读取的时候，才必须区分大小端字节序，其它情况都不用考虑</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//因此对于我们来说，在网络传输当中我们传输的是字节数组</span></span><br><span class="line">        <span class="comment">//那么我们在收到字节数组进行解析时，就需要考虑大小端的问题</span></span><br><span class="line">        <span class="comment">//虽然TCP/IP协议规定了在网络上必须采用网络字节顺序（大端模式）</span></span><br><span class="line">        <span class="comment">//但是具体传输时采用哪种模式，都是根据前后端语言、设备决定的</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//在进行网络通讯时，前后端语言不同时，可能会造成大小端不统一</span></span><br><span class="line">        <span class="comment">//一般情况下</span></span><br><span class="line">        <span class="comment">//C# 和 Java/Erlang/AS3 通讯需要进行大小端转换 因为C#是小端模式 Java/Erlang/AS3是大端模式</span></span><br><span class="line">        <span class="comment">//C# 与 C++通信不需要特殊处理 他们都是小端模式</span></span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 知识点四 大小端转换</span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 1.判断是大小端哪种模式</span></span><br><span class="line">        print(<span class="string">&quot;是否是小端模式:&quot;</span> + BitConverter.IsLittleEndian);</span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 2.简单的转换API 只支持几种类型</span></span><br><span class="line">        <span class="comment">//转换为网络字节序 相当于就是转为大端模式</span></span><br><span class="line">        <span class="comment">//1. 本机字节序转网络字节序</span></span><br><span class="line">        <span class="built_in">int</span> i = <span class="number">99</span>;</span><br><span class="line">        <span class="built_in">byte</span>[] bytes = BitConverter.GetBytes(IPAddress.HostToNetworkOrder(i));</span><br><span class="line">        <span class="comment">//2. 网络字节序转本机字节序</span></span><br><span class="line">        <span class="built_in">int</span> receI = BitConverter.ToInt32(bytes, <span class="number">0</span>);</span><br><span class="line">        receI = IPAddress.NetworkToHostOrder(receI);</span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 3.通用的转换方式</span></span><br><span class="line">        <span class="comment">//数组中的倒序API</span></span><br><span class="line">        <span class="comment">//如果后端需要用到大端模式 那么我们进行判断</span></span><br><span class="line">        <span class="comment">//如果当前是小端模式 就进行一次 大小端转换</span></span><br><span class="line">        <span class="keyword">if</span>(BitConverter.IsLittleEndian)</span><br><span class="line">            Array.Reverse(bytes);</span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 总结</span></span><br><span class="line">        <span class="comment">//大小端模式会根据主机硬件环境不同、语言不同而有所区别</span></span><br><span class="line">        <span class="comment">//当我们前后端是不同语言开发且运行在不同主机上时</span></span><br><span class="line">        <span class="comment">//前后端需要对大小端字节序定下统一的规则</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//一般让前端迎合后端，因为字节序的转换也是会带来些许性能损耗的</span></span><br><span class="line">        <span class="comment">//网络游戏中要尽量减轻后端的负担</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//一般情况下</span></span><br><span class="line">        <span class="comment">//C# 和 Java/Erlang/AS3 通讯需要进行大小端转换 前端C#从小变大</span></span><br><span class="line">        <span class="comment">//C# 与 C++通信不需要特殊处理</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//我们不用死记硬背和谁通讯要注意大小端模式</span></span><br><span class="line">        <span class="comment">//当开发时，发现后端收到的消息和前端发的不一样</span></span><br><span class="line">        <span class="comment">//在协议统一的情况下，往往就是因为大小端造成的</span></span><br><span class="line">        <span class="comment">//这时我们再转换模式即可</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//注意：</span></span><br><span class="line">        <span class="comment">//Protobuf已经帮助我们解决了大小端问题</span></span><br><span class="line">        <span class="comment">//即使前后端语言不统一</span></span><br><span class="line">        <span class="comment">//使用它也不用过多考虑字节序转换的问题</span></span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update is called once per frame</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="消息加密"><a href="#消息加密" class="headerlink" title="消息加密"></a>消息加密</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> GamePlayerTest;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Lesson44</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Start is called before the first frame update</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 知识点一 什么是消息加密解密</span></span><br><span class="line">        <span class="comment">//我们在网路传输时，会把数据转换为字节数组以2进制的形式进行传输</span></span><br><span class="line">        <span class="comment">//理论上来说，如果有人截取篡改了消息，或者从前端发假消息给后端</span></span><br><span class="line">        <span class="comment">//就可能产生作弊行为</span></span><br><span class="line">        <span class="comment">//消息的加密解密 可以有效避免作弊行为的产生</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//加密</span></span><br><span class="line">        <span class="comment">//采用一些方式对数据进行处理后，使数据从表面上看，已经不能表达出原有的意思</span></span><br><span class="line">        <span class="comment">//别人就算获取到了你的信息，也无法知道你的内容的含义和规则</span></span><br><span class="line">        <span class="comment">//这样可以让我们的数据更加的安全，降低被篡改的可能性</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//解密</span></span><br><span class="line">        <span class="comment">//通过对加密过的数据采用某些方法，去还原原有数据，从而获取目标数据</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//这部分知识点 和我们在数据持久化四部曲中——2进制 学习的加密内容类似</span></span><br><span class="line">        <span class="comment">//其实就是在</span></span><br><span class="line">        <span class="comment">//发消息时，对我们的消息2进制数据进行加密（一般只对消息体加密）</span></span><br><span class="line">        <span class="comment">//收到消息时，对2进制数据进行解密（一般只对消息体解密）</span></span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 知识点二 加密是否是100%安全？</span></span><br><span class="line">        <span class="comment">//一定记住加密只是提高破解门槛，没有100%保密的数据</span></span><br><span class="line">        <span class="comment">//通过各种尝试始终是可以破解加密规则的，只是时间问题</span></span><br><span class="line">        <span class="comment">//加密只能提升一定的安全性</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//对于大多数情况下已经够用了，除非专门有人针对你们的产品进行破解</span></span><br><span class="line">        <span class="comment">//但是遇到这种情况 也证明你的产品已经足够成功了</span></span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 知识点三 加密解密的相关名词解释</span></span><br><span class="line">        <span class="comment">//明文：待加密的报文（内容）</span></span><br><span class="line">        <span class="comment">//密文：加密后的报文（内容）</span></span><br><span class="line">        <span class="comment">//密钥：加密过程中或解密过程中输入的数据</span></span><br><span class="line">        <span class="comment">//算法：将明文和密钥相结合进行处理，生成密文的方法，叫加密算法</span></span><br><span class="line">        <span class="comment">//     将密文和密钥相结合进行处理，生成明文的方法，叫解密算法</span></span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 知识点四 了解加密算法分类</span></span><br><span class="line">        <span class="comment">//1.单向加密</span></span><br><span class="line">        <span class="comment">//  将数据进行计算变成另一种固定长度的值，这种加密是不可逆的</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//  常用算法</span></span><br><span class="line">        <span class="comment">//  MD5、SHA1、SHA256等</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//  用途：这种加密在网络传输中不会使用，主要用到其它功能当中，比如密码的单向加密</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//2.对称加密技术</span></span><br><span class="line">        <span class="comment">//  使用同一个密钥，对数据镜像加密和解密（用密钥对明文加密，用密钥对密文解密）</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//  常用算法</span></span><br><span class="line">        <span class="comment">//  DES、3DES、IDEA、AES等</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//  优点：计算量小，加密速度快、效率高</span></span><br><span class="line">        <span class="comment">//  缺点：如果知道了密钥和算法，就可以进行解密</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//  用途：网路通讯中可以使用对称加密技术，这个密钥可以是由后端下发的，每次建立通讯后都会变化的</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.非对称加密技术</span></span><br><span class="line">        <span class="comment">//  在加密过程中，需要一对密钥，不公开的密钥称为私钥，公开的那一个密钥称为公钥</span></span><br><span class="line">        <span class="comment">//  也可以称为公开密钥加密</span></span><br><span class="line">        <span class="comment">//  从一对密钥中的任何一个密钥都不能计算出另一个密钥</span></span><br><span class="line">        <span class="comment">//  使用一对密钥中的任何一个加密，只有另一个密钥才能解密。如果截获公钥加密数据，没有私钥也无法解密</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//  常用算法</span></span><br><span class="line">        <span class="comment">//  RSA、DSA等</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//  优点：安全性高，即使获取到了公钥，没有私钥也无法进行解密</span></span><br><span class="line">        <span class="comment">//  缺点：算法复杂，加密速度较慢</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//  用途：对安全性要求较高的场景，并且可以接受较慢的加密速度的需求可以使用非对称加密技术</span></span><br><span class="line">        <span class="comment">//        以后在对接一些支付SDK时经常会看到平台提供的就是非对称加密技术</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//关于这些加密算法</span></span><br><span class="line">        <span class="comment">//有很多的别人写好的第三发加密算法库</span></span><br><span class="line">        <span class="comment">//可以直接获取用于在程序中对数据进行加密</span></span><br><span class="line">        <span class="comment">//也可以自己基于加密算法原理来设计自己的规则</span></span><br><span class="line">        <span class="comment">//这里我们不深究 感兴趣的同学可以自己去了解</span></span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 知识点五 用简单的异或加密感受加密的作用</span></span><br><span class="line">        <span class="comment">//异或加密特点</span></span><br><span class="line">        <span class="comment">//密钥为一个整数</span></span><br><span class="line">        <span class="comment">//明文 异或 密钥 得到 密文</span></span><br><span class="line">        <span class="comment">//密文 异或 密钥 得到 明文</span></span><br><span class="line"></span><br><span class="line">        TestMsg msg = <span class="keyword">new</span> TestMsg();</span><br><span class="line">        msg.ListInt.Add(<span class="number">1</span>);</span><br><span class="line">        msg.TestBool = <span class="literal">false</span>;</span><br><span class="line">        msg.TestD = <span class="number">5.5</span>;</span><br><span class="line">        msg.TestInt32 = <span class="number">99</span>;</span><br><span class="line">        msg.TestMap.Add(<span class="number">1</span>, <span class="string">&quot;唐老狮&quot;</span>);</span><br><span class="line">        msg.TestMsg2 = <span class="keyword">new</span> TestMsg2();</span><br><span class="line">        msg.TestMsg2.TestInt32 = <span class="number">88</span>;</span><br><span class="line">        msg.TestMsg3 = <span class="keyword">new</span> TestMsg.Types.TestMsg3();</span><br><span class="line">        msg.TestMsg3.TestInt32 = <span class="number">66</span>;</span><br><span class="line"></span><br><span class="line">        msg.TestHeart = <span class="keyword">new</span> GameSystemTest.HeartMsg();</span><br><span class="line">        msg.TestHeart.Time = <span class="number">7777</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">byte</span>[] bytes = NetTool.GetProtoBytes(msg);</span><br><span class="line">        <span class="comment">//异或加密算法</span></span><br><span class="line">        <span class="comment">//密钥声明</span></span><br><span class="line">        <span class="built_in">byte</span> s = <span class="number">55</span>;</span><br><span class="line">        <span class="comment">//异或加密</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; bytes.Length; i++)</span><br><span class="line">            bytes[i] ^= s;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//异或解密</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; bytes.Length; i++)</span><br><span class="line">            bytes[i] ^= s;</span><br><span class="line"></span><br><span class="line">        TestMsg msg2 = NetTool.GetProtoMsg&lt;TestMsg&gt;(bytes);</span><br><span class="line">        print(msg2.TestMsg3.TestInt32);</span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 总结</span></span><br><span class="line">        <span class="comment">//有各种各样的加密算法可以应用在网络通讯的消息加密中</span></span><br><span class="line">        <span class="comment">//由于加密算法完全是可以单独开一门课来讲解的内容</span></span><br><span class="line">        <span class="comment">//所以我们在这里只做了解</span></span><br><span class="line">        <span class="comment">//我们只要知道加密对于我们意义即可</span></span><br><span class="line">        <span class="comment">//当需要用到时，再去学习对应的加密算法也是可以的</span></span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update is called once per frame</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h1><h2 id="HTTP的工作原理"><a href="#HTTP的工作原理" class="headerlink" title="HTTP的工作原理"></a>HTTP的工作原理</h2><p>1.http是以TCP的方式进行工作的</p>
<p>连接 – 请求 – 响应 – 断开 </p>
<p>2.HTTP是无状态的</p>
<p>客户端要什么给什么，想要多少来多少</p>
<p>3.HTTP使用元信息作为标头</p>
<p>主要在数据前添加一部分额外信息（元信息）</p>
<p>包含传送的对象属于哪种类型，采用的是哪种编码方式等等</p>
<h2 id="HTTP的请求类型和响应状态码"><a href="#HTTP的请求类型和响应状态码" class="headerlink" title="HTTP的请求类型和响应状态码"></a>HTTP的请求类型和响应状态码</h2><p>HTTP协议定义了多种请求类型（Request Methods）和响应状态码（Status Codes），用于指定请求的操作类型和表示响应的状态。以下是常见的HTTP请求类型和响应状态码：</p>
<p>HTTP请求类型（Request Methods）：</p>
<ol>
<li>GET：从服务器获取资源。</li>
<li>POST：向服务器提交数据，并创建新的资源。</li>
<li>PUT：向服务器更新或替换资源。</li>
<li>DELETE：删除服务器上的资源。</li>
<li>HEAD：获取资源的元数据，而不获取实际内容。</li>
<li>OPTIONS：获取服务器支持的请求类型和功能选项。</li>
<li>PATCH：对资源进行部分更新。</li>
<li>TRACE：对请求进行回显，以测试和诊断。</li>
</ol>
<p>HTTP响应状态码（Status Codes）：</p>
<p>1xx（信息性响应）：请求已接收，继续处理。</p>
<p>2xx（成功响应）：请求已成功处理和接受。</p>
<ul>
<li>200 OK：请求成功，并返回所请求的数据。</li>
<li>201 Created：请求成功创建了新资源。</li>
<li>204 No Content：请求成功处理，但没有返回数据。</li>
</ul>
<p>3xx（重定向响应）：需要采取进一步操作来完成请求。</p>
<ul>
<li>301 Moved Permanently：请求的资源已永久移动到新位置。</li>
<li>302 Found：请求的资源临时移动到新位置。</li>
<li>304 Not Modified：请求资源未被修改，可使用缓存的版本。</li>
</ul>
<p>4xx（客户端错误响应）：请求包含错误或无法完成请求。</p>
<ul>
<li>400 Bad Request：请求无效或错误。</li>
<li>401 Unauthorized：请求需要身份验证。</li>
<li>403 Forbidden：服务器拒绝请求访问。</li>
<li>404 Not Found：请求的资源未找到。</li>
</ul>
<p>5xx（服务器错误响应）：服务器无法完成有效请求。</p>
<ul>
<li>500 Internal Server Error：服务器内部错误。</li>
<li>502 Bad Gateway：服务器作为网关或代理接收到无效响应。</li>
<li>503 Service Unavailable：服务器当前无法处理请求。</li>
</ul>
<h2 id="HTTP常用类"><a href="#HTTP常用类" class="headerlink" title="HTTP常用类"></a>HTTP常用类</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Lesson24</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Start is called before the first frame update</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 知识点一 HttpWebRequest类</span></span><br><span class="line">        <span class="comment">//命名空间：System.Net</span></span><br><span class="line">        <span class="comment">//HttpWebRequest是主要用于发送客户端请求的类</span></span><br><span class="line">        <span class="comment">//主要用于：发送HTTP客户端请求给服务器，可以进行消息通信、上传、下载等等操作</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//重要方法</span></span><br><span class="line">        <span class="comment">//1.Create 创建新的WebRequest，用于进行HTTP相关操作</span></span><br><span class="line">        HttpWebRequest req = HttpWebRequest.Create(<span class="keyword">new</span> Uri(<span class="string">&quot;http://192.168.50.109:8000/Http_Server/&quot;</span>)) <span class="keyword">as</span> HttpWebRequest;</span><br><span class="line">        <span class="comment">//2.Abort  如果正在进行文件传输，用此方法可以终止传输 </span></span><br><span class="line">        <span class="comment">//req.Abort();</span></span><br><span class="line">        <span class="comment">//3.GetRequestStream  获取用于上传的流</span></span><br><span class="line">        Stream s = req.GetRequestStream();</span><br><span class="line">        <span class="comment">//4.GetResponse  返回HTTP服务器响应</span></span><br><span class="line">        HttpWebResponse res = req.GetResponse() <span class="keyword">as</span> HttpWebResponse;</span><br><span class="line">        <span class="comment">//5.Begin/EndGetRequestStream 异步获取用于上传的流</span></span><br><span class="line">        <span class="comment">//req.BeginGetRequestStream()</span></span><br><span class="line">        <span class="comment">//6.Begin/EndGetResponse 异步获取返回的HTTP服务器响应</span></span><br><span class="line">        <span class="comment">//req.BeginGetResponse()</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//重要成员</span></span><br><span class="line">        <span class="comment">//1.Credentials 通信凭证，设置为NetworkCredential对象</span></span><br><span class="line">        req.Credentials = <span class="keyword">new</span> NetworkCredential(<span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="comment">//2.PreAuthenticate 是否随请求发送一个身份验证标头,一般需要进行身份验证时需要将其设置为true</span></span><br><span class="line">        req.PreAuthenticate = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.Headers 构成标头的名称/值对的集合</span></span><br><span class="line">        <span class="comment">//req.Headers</span></span><br><span class="line">        <span class="comment">//4.ContentLength 发送信息的字节数 上传信息时需要先设置该内容长度</span></span><br><span class="line">        req.ContentLength = <span class="number">100</span>;</span><br><span class="line">        <span class="comment">//5.ContentType 在进行POST请求时，需要对发送的内容进行内容类型的设置</span></span><br><span class="line">        <span class="comment">//6.Method  操作命令设置</span></span><br><span class="line">        <span class="comment">//  WebRequestMethods.Http类中的操作命令属性</span></span><br><span class="line">        <span class="comment">//  Get     获取请求，一般用于获取数据</span></span><br><span class="line">        <span class="comment">//  Post    提交请求，一般用于上传数据，同时可以获取</span></span><br><span class="line">        <span class="comment">//  Head    获取和Get一致的内容，只是只会返回消息头，不会返回具体内容</span></span><br><span class="line">        <span class="comment">//  Put     向指定位置上传最新内容</span></span><br><span class="line">        <span class="comment">//  Connect 表示与代理一起使用的 HTTP CONNECT 协议方法，该代理可以动态切换到隧道</span></span><br><span class="line">        <span class="comment">//  MkCol   请求在请求 URI（统一资源标识符）指定的位置新建集合</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//了解该类的更多信息</span></span><br><span class="line">        <span class="comment">//https://docs.microsoft.com/zh-cn/dotnet/api/system.net.httpwebrequest?view=net-6.0</span></span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 知识点二 HttpWebResponse类</span></span><br><span class="line">        <span class="comment">//命名空间：System.Net</span></span><br><span class="line">        <span class="comment">//它主要用于获取服务器反馈信息的类</span></span><br><span class="line">        <span class="comment">//我们可以通过HttpWebRequest对象中的GetResponse()方法获取</span></span><br><span class="line">        <span class="comment">//当使用完毕时，要使用Close释放</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//重要方法：</span></span><br><span class="line">        <span class="comment">//1.Close:释放所有资源</span></span><br><span class="line">        <span class="comment">//2.GetResponseStream：返回从FTP服务器下载数据的流</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//重要成员：</span></span><br><span class="line">        <span class="comment">//1.ContentLength:接受到数据的长度</span></span><br><span class="line">        <span class="comment">//2.ContentType：接受数据的类型</span></span><br><span class="line">        <span class="comment">//3.StatusCode:HTTP服务器下发的最新状态码</span></span><br><span class="line">        <span class="comment">//4.StatusDescription:HTTP服务器下发的状态代码的文本</span></span><br><span class="line">        <span class="comment">//5.BannerMessage:登录前建立连接时HTTP服务器发送的消息</span></span><br><span class="line">        <span class="comment">//6.ExitMessage:HTTP会话结束时服务器发送的消息</span></span><br><span class="line">        <span class="comment">//7.LastModified:HTTP服务器上的文件的上次修改日期和时间</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//了解该类的更多信息</span></span><br><span class="line">        <span class="comment">//https://docs.microsoft.com/zh-cn/dotnet/api/system.net.httpwebresponse?view=net-6.0</span></span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 知识点三 NetworkCredential、Uri、Stream、FileStream类</span></span><br><span class="line">        <span class="comment">//这些类我们在学习Ftp时已经使用过了</span></span><br><span class="line">        <span class="comment">//在HTTP通讯时使用方式不变</span></span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 总结</span></span><br><span class="line">        <span class="comment">//Http相关通讯类的使用和Ftp非常类似</span></span><br><span class="line">        <span class="comment">//只有一些细节上的区别</span></span><br><span class="line">        <span class="comment">//之后我们在学习上传下载时再来着重讲解</span></span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update is called once per frame</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="HTTP下载文件"><a href="#HTTP下载文件" class="headerlink" title="HTTP下载文件"></a>HTTP下载文件</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Lesson25</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Start is called before the first frame update</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 知识点一 检测资源可用性</span></span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//利用Head请求类型，获取信息</span></span><br><span class="line">            <span class="comment">//1.创建HTTP通讯用连接对象HttpWebRequest对象</span></span><br><span class="line">            HttpWebRequest req = HttpWebRequest.Create(<span class="keyword">new</span> Uri(<span class="string">&quot;http://192.168.50.49:8000/Http_Server/实战就业路线.jpg&quot;</span>)) <span class="keyword">as</span> HttpWebRequest;</span><br><span class="line">            <span class="comment">//2.设置请求类型 或 其它相关参数</span></span><br><span class="line">            req.Method = WebRequestMethods.Http.Head;</span><br><span class="line">            req.Timeout = <span class="number">2000</span>;</span><br><span class="line">            <span class="comment">//3.发送请求，获取响应结果HttpWebResponse对象</span></span><br><span class="line">            HttpWebResponse res = req.GetResponse() <span class="keyword">as</span> HttpWebResponse;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (res.StatusCode == HttpStatusCode.OK)</span><br><span class="line">            &#123;</span><br><span class="line">                print(<span class="string">&quot;文件存在且可用&quot;</span>);</span><br><span class="line">                print(res.ContentLength);</span><br><span class="line">                print(res.ContentType);</span><br><span class="line"></span><br><span class="line">                res.Close();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                print(<span class="string">&quot;文件不能用&quot;</span> + res.StatusCode);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (WebException w)</span><br><span class="line">        &#123;</span><br><span class="line">            print(<span class="string">&quot;获取出错&quot;</span> + w.Message + w.Status);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 知识点二 下载资源</span></span><br><span class="line">        <span class="comment">//利用Get请求类型，下载资源</span></span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//1.创建HTTP通讯用连接对象HttpWebRequest对象</span></span><br><span class="line">            HttpWebRequest req = HttpWebRequest.Create(<span class="keyword">new</span> Uri(<span class="string">&quot;http://192.168.50.49:8000/Http_Server/实战就业路线.jpg&quot;</span>)) <span class="keyword">as</span> HttpWebRequest;</span><br><span class="line">            <span class="comment">//2.设置请求类型 或 其它相关参数</span></span><br><span class="line">            req.Method = WebRequestMethods.Http.Get;</span><br><span class="line">            req.Timeout = <span class="number">3000</span>;</span><br><span class="line">            <span class="comment">//3.发送请求，获取响应结果HttpWebResponse对象</span></span><br><span class="line">            HttpWebResponse res = req.GetResponse() <span class="keyword">as</span> HttpWebResponse;</span><br><span class="line">            <span class="comment">//4.获取响应数据流，写入本地路径</span></span><br><span class="line">            <span class="keyword">if</span> (res.StatusCode == HttpStatusCode.OK)</span><br><span class="line">            &#123;</span><br><span class="line">                print(Application.persistentDataPath);</span><br><span class="line">                <span class="keyword">using</span> (FileStream fileStream = File.Create(Application.persistentDataPath + <span class="string">&quot;/httpDownLoad.jpg&quot;</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    Stream downLoadStream = res.GetResponseStream();</span><br><span class="line">                    <span class="built_in">byte</span>[] bytes = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">2048</span>];</span><br><span class="line">                    <span class="comment">//读取数据</span></span><br><span class="line">                    <span class="built_in">int</span> contentLength = downLoadStream.Read(bytes, <span class="number">0</span>, bytes.Length);</span><br><span class="line">                    <span class="comment">//一点一点的写入本地</span></span><br><span class="line">                    <span class="keyword">while</span> (contentLength != <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        fileStream.Write(bytes, <span class="number">0</span>, contentLength);</span><br><span class="line">                        contentLength = downLoadStream.Read(bytes, <span class="number">0</span>, bytes.Length);</span><br><span class="line">                    &#125;</span><br><span class="line">                    fileStream.Close();</span><br><span class="line">                    downLoadStream.Close();</span><br><span class="line">                    res.Close();</span><br><span class="line">                &#125;</span><br><span class="line">                print(<span class="string">&quot;下载成功&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                print(<span class="string">&quot;下载失败&quot;</span> + res.StatusCode);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (WebException w)</span><br><span class="line">        &#123;</span><br><span class="line">            print(<span class="string">&quot;下载出错&quot;</span> + w.Status + w.Message);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 知识点三 Get请求类型携带额外信息</span></span><br><span class="line">        <span class="comment">//我们在进行HTTP通信时，可以在地址后面加一些额外参数传递给服务端</span></span><br><span class="line">        <span class="comment">//一般在和短连接游戏服务器通讯时，需要携带额外信息</span></span><br><span class="line">        <span class="comment">//举例：</span></span><br><span class="line">        <span class="comment">//http://www.aspxfans.com:8080/news/child/index.asp?boardID=5&amp;ID=24618&amp;page=1</span></span><br><span class="line">        <span class="comment">//这个链接可以分成几部分</span></span><br><span class="line">        <span class="comment">//1.协议部分：取决于服务器端使用的哪种协议</span></span><br><span class="line">        <span class="comment">//http://  —— 普通的http超文本传输协议</span></span><br><span class="line">        <span class="comment">//https:// —— 加密的超文本传输协议</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//2.域名部分：</span></span><br><span class="line">        <span class="comment">//www.aspxfans.com</span></span><br><span class="line">        <span class="comment">//也可以填写服务器的公网IP地址</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.端口部分：</span></span><br><span class="line">        <span class="comment">//8080</span></span><br><span class="line">        <span class="comment">//可以不写，如果不写默认为80</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//4.虚拟目录部分：</span></span><br><span class="line">        <span class="comment">//news/child/</span></span><br><span class="line">        <span class="comment">//域名后的/开始，到最后一个/之前的部分</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//5.文件名部分：</span></span><br><span class="line">        <span class="comment">//index.asp</span></span><br><span class="line">        <span class="comment">//？之前的最后一个/后的部分</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//6.参数部分：</span></span><br><span class="line">        <span class="comment">//boardID=5&amp;ID=24618&amp;page=1</span></span><br><span class="line">        <span class="comment">//？之后的部分就是参数部分，多个参数一&amp;分隔开</span></span><br><span class="line">        <span class="comment">//这里有三个参数</span></span><br><span class="line">        <span class="comment">//boardID = 5</span></span><br><span class="line">        <span class="comment">//ID = 24618</span></span><br><span class="line">        <span class="comment">//page = 1</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//我们在和服务端进行通信时，只要按照这种规则格式进行通信，就可以传递参数给对象</span></span><br><span class="line">        <span class="comment">//主要可用于：</span></span><br><span class="line">        <span class="comment">//1.web网站服务器</span></span><br><span class="line">        <span class="comment">//2.游戏短连接服务器</span></span><br><span class="line">        <span class="comment">//等</span></span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 总结</span></span><br><span class="line">        <span class="comment">//1.Head请求类型</span></span><br><span class="line">        <span class="comment">//主要用于获取文件的一些基础信息 可以用于确定文件是否存在</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//2.Get请求类型 主要用于传递信息给服务器，用于获取具体信息</span></span><br><span class="line">        <span class="comment">//  服务器返回的信息，可以通过Response中的流来获取</span></span><br><span class="line">        <span class="comment">//  用Get请求时，可以在连接中携带一些额外参数(在链接后面加上 ?参数名=参数值&amp;参数名=参数值&amp;参数名=参数值&amp;。。。。)</span></span><br><span class="line">        <span class="comment">//  正常的http服务器应用程序，都会去解析Get请求时连接中的参数进行逻辑处理（后端程序的工作）</span></span><br><span class="line">        <span class="comment">//  我们主要要掌握的知识点：</span></span><br><span class="line">        <span class="comment">//  1.额外参数按格式书写</span></span><br><span class="line">        <span class="comment">//  2.通过response对象中的流来获取返回的数据（数据的类型多种多样，可以是文件、自定义消息等等，我们按照规则解析即可）</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.在和http服务器通信时，我们经常会使用额外参数的形式传递信息，特别是以后和一些运营平台对接时</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//4.文件下载功能和Ftp非常类似，只是其中使用的类、协议、请求类型不同而已</span></span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update is called once per frame</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="异步下载-1"><a href="#异步下载-1" class="headerlink" title="异步下载"></a>异步下载</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.Events;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HttpMgr</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> HttpMgr instance = <span class="keyword">new</span> HttpMgr();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HttpMgr Instance =&gt; instance;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> HTTP_PATH = <span class="string">&quot;http://192.168.50.49:8000/Http_Server/&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 下载指定文件到本地指定路径中</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;fileName&quot;&gt;</span>远程文件名<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;loacFilePath&quot;&gt;</span>本地路径<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;action&quot;&gt;</span>下载结束后的回调函数<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> <span class="keyword">void</span> <span class="title">DownLoadFile</span>(<span class="params"><span class="built_in">string</span> fileName, <span class="built_in">string</span> loacFilePath, UnityAction&lt;HttpStatusCode&gt; action</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        HttpStatusCode result = HttpStatusCode.OK;</span><br><span class="line">        <span class="keyword">await</span> Task.Run(() =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//判断文件是否存在 Head </span></span><br><span class="line">                <span class="comment">//1.创建HTTP连接对象</span></span><br><span class="line">                HttpWebRequest req = HttpWebRequest.Create(HTTP_PATH + fileName) <span class="keyword">as</span> HttpWebRequest;</span><br><span class="line">                <span class="comment">//2.设置请求类型 和 其它相关参数</span></span><br><span class="line">                req.Method = WebRequestMethods.Http.Head;</span><br><span class="line">                req.Timeout = <span class="number">2000</span>;</span><br><span class="line">                <span class="comment">//3.发送请求</span></span><br><span class="line">                HttpWebResponse res = req.GetResponse() <span class="keyword">as</span> HttpWebResponse;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//存在才下载</span></span><br><span class="line">                <span class="keyword">if</span>(res.StatusCode == HttpStatusCode.OK)</span><br><span class="line">                &#123;</span><br><span class="line">                    res.Close();</span><br><span class="line">                    <span class="comment">//下载</span></span><br><span class="line">                    <span class="comment">//1.创建HTTP连接对象</span></span><br><span class="line">                    req = HttpWebRequest.Create(HTTP_PATH + fileName) <span class="keyword">as</span> HttpWebRequest;</span><br><span class="line">                    <span class="comment">//2.设置请求类型 和 其它相关参数</span></span><br><span class="line">                    req.Method = WebRequestMethods.Http.Get;</span><br><span class="line">                    req.Timeout = <span class="number">2000</span>;</span><br><span class="line">                    <span class="comment">//3.发送请求</span></span><br><span class="line">                    res = req.GetResponse() <span class="keyword">as</span> HttpWebResponse;</span><br><span class="line">                    <span class="comment">//4.存储数据到本地</span></span><br><span class="line">                    <span class="keyword">if</span>(res.StatusCode == HttpStatusCode.OK)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">//存储数据</span></span><br><span class="line">                        <span class="keyword">using</span> (FileStream fileStream = File.Create(loacFilePath))</span><br><span class="line">                        &#123;</span><br><span class="line">                            Stream stream = res.GetResponseStream();</span><br><span class="line">                            <span class="built_in">byte</span>[] bytes = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">4096</span>];</span><br><span class="line">                            <span class="built_in">int</span> contentLength = stream.Read(bytes, <span class="number">0</span>, bytes.Length);</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">while</span> (contentLength != <span class="number">0</span>)</span><br><span class="line">                            &#123;</span><br><span class="line">                                fileStream.Write(bytes, <span class="number">0</span>, contentLength);</span><br><span class="line">                                contentLength = stream.Read(bytes, <span class="number">0</span>, bytes.Length);</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            fileStream.Close();</span><br><span class="line">                            stream.Close();</span><br><span class="line">                        &#125;</span><br><span class="line">                        result = HttpStatusCode.OK;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        result = res.StatusCode;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    result = res.StatusCode;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                res.Close();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (WebException w)</span><br><span class="line">            &#123;</span><br><span class="line">                result = HttpStatusCode.InternalServerError;</span><br><span class="line">                Debug.Log(<span class="string">&quot;下载出错&quot;</span> + w.Message + w.Status);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        action?.Invoke(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Post知识"><a href="#Post知识" class="headerlink" title="Post知识"></a>Post知识</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Lesson26</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Start is called before the first frame update</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 知识点一 Get和Post的区别</span></span><br><span class="line">        <span class="comment">//我们上节课学习的下载数据，主要使用的就是Get请求类型</span></span><br><span class="line">        <span class="comment">//我们在上传数据时将会使用Post请求类型</span></span><br><span class="line">        <span class="comment">//那么这两个请求类型他们的主要区别是什么呢？</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//1.主要用途</span></span><br><span class="line">        <span class="comment">//  Get — 一般从指定的资源请求数据,主要用于获取数据</span></span><br><span class="line">        <span class="comment">//  Post — 一般向指定的资源提交想要被处理的数据，主要用于上传数据</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//2.相同点</span></span><br><span class="line">        <span class="comment">//  Get和Post都可以传递一些额外的参数数据给服务端</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.不同点</span></span><br><span class="line">        <span class="comment">//  3-1:在传递参数时，Post相对Get更加的安全，因为Post看不到参数</span></span><br><span class="line">        <span class="comment">//      Get传递的参数都包含在连接中（URL资源定位地址），是暴露式的 ?参数名=参数值&amp;参数名=参数值</span></span><br><span class="line">        <span class="comment">//      Post传递的参数放在请求数据中，不会出现在URL中，是隐藏式的</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">//  3-2:Get在传递数据时有大小的限制，因为它主要是在连接中拼接参数，而URL的长度是有限制的（最大长度一般为2048个字符）</span></span><br><span class="line">        <span class="comment">//      Post在传递数据时没有限制</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">//  3-3:在浏览器中Get请求能被缓存，Post不能缓存</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//  3-4:传输次数可能不同</span></span><br><span class="line">        <span class="comment">//      Get:  建立连接——&gt;请求行、请求头、请求数据一次传输——&gt;获取响应——&gt;断开连接</span></span><br><span class="line">        <span class="comment">//      Post: 建立连接——&gt;传输可能分两次——&gt;请求行，请求头第一次传输——&gt;请求数据第二次传输——&gt;获取响应——&gt;断开</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//对于前端来说，其实Get和Post都是能够获取和传递数据的,后端只要处理对应逻辑返回响应信息即可</span></span><br><span class="line">        <span class="comment">//但是由于他们的这些特点</span></span><br><span class="line">        <span class="comment">//我们在实际使用时建议Get用于获取，Post用于上传</span></span><br><span class="line">        <span class="comment">//如果想要传递一些不想暴露在外部的参数信息，建议使用Post，它更加的安全</span></span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 知识点二 Post如何携带额外参数</span></span><br><span class="line">        <span class="comment">//关键点：将Content-Type设置为 application/x-www-form-urlencoded 键值对类型</span></span><br><span class="line">        HttpWebRequest req = HttpWebRequest.Create(<span class="string">&quot;http://192.168.50.109:8000/Http_Server/&quot;</span>) <span class="keyword">as</span> HttpWebRequest;</span><br><span class="line">        req.Method = WebRequestMethods.Http.Post;</span><br><span class="line">        req.Timeout = <span class="number">2000</span>;</span><br><span class="line">        <span class="comment">//设置上传的内容的类型</span></span><br><span class="line">        req.ContentType = <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//我们要上传的数据</span></span><br><span class="line">        <span class="built_in">string</span> str = <span class="string">&quot;Name=MrTang&amp;ID=2&quot;</span>;</span><br><span class="line">        <span class="built_in">byte</span>[] bytes = Encoding.UTF8.GetBytes(str);</span><br><span class="line">        <span class="comment">//我们在上传之前一定要设置内容的长度</span></span><br><span class="line">        req.ContentLength = bytes.Length;</span><br><span class="line">        <span class="comment">//上传数据</span></span><br><span class="line">        Stream stream = req.GetRequestStream();</span><br><span class="line">        stream.Write(bytes, <span class="number">0</span>, bytes.Length);</span><br><span class="line">        stream.Close();</span><br><span class="line">        <span class="comment">//发送数据 得到响应结果</span></span><br><span class="line">        HttpWebResponse res = req.GetResponse() <span class="keyword">as</span> HttpWebResponse;</span><br><span class="line">        print(res.StatusCode);</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 知识点三 ContentType的常用类型</span></span><br><span class="line">        <span class="comment">//ContentType的构成：</span></span><br><span class="line">        <span class="comment">//内容类型;charset=编码格式;boundary=边界字符串</span></span><br><span class="line">        <span class="comment">//text/html;charset=utf-8;boundary=自定义字符串</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//其中内容类型有：</span></span><br><span class="line">        <span class="comment">//文本类型text：</span></span><br><span class="line">        <span class="comment">//text/plain 没有特定子类型就是它（重要）</span></span><br><span class="line">        <span class="comment">//text/html</span></span><br><span class="line">        <span class="comment">//text/css</span></span><br><span class="line">        <span class="comment">//text/javascript</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//图片类型image：</span></span><br><span class="line">        <span class="comment">//image/gif</span></span><br><span class="line">        <span class="comment">//image/png</span></span><br><span class="line">        <span class="comment">//image/jpeg</span></span><br><span class="line">        <span class="comment">//image/bm</span></span><br><span class="line">        <span class="comment">//image/webp</span></span><br><span class="line">        <span class="comment">//image/x-icon</span></span><br><span class="line">        <span class="comment">//image/vnd.microsoft.icon</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//音频类型audio：</span></span><br><span class="line">        <span class="comment">//audio/midi</span></span><br><span class="line">        <span class="comment">//audio/mpeg</span></span><br><span class="line">        <span class="comment">//audio/webm</span></span><br><span class="line">        <span class="comment">//audio/ogg</span></span><br><span class="line">        <span class="comment">//audio/wav</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//视频类型video:</span></span><br><span class="line">        <span class="comment">//video/webm</span></span><br><span class="line">        <span class="comment">//video/ogg</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//二进制类型application:</span></span><br><span class="line">        <span class="comment">//application/octet-stream 没有特定子类型就是它（重要）</span></span><br><span class="line">        <span class="comment">//application/x-www-form-urlencoded 传递参数时使用键值对形式（重要）</span></span><br><span class="line">        <span class="comment">//application/pkcs12</span></span><br><span class="line">        <span class="comment">//application/xhtml+xml</span></span><br><span class="line">        <span class="comment">//application/xml</span></span><br><span class="line">        <span class="comment">//application/pdf</span></span><br><span class="line">        <span class="comment">//application/vnd.mspowerpoint</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//复合内容multipart:</span></span><br><span class="line">        <span class="comment">//multipart/form-data  复合内容，有多种内容组合（重要）</span></span><br><span class="line">        <span class="comment">//multipart/byteranges  特殊的复合文件</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//关于ContentType更多内容可以前往</span></span><br><span class="line">        <span class="comment">//https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Type</span></span><br><span class="line">        <span class="comment">//关于媒体类型可以前往</span></span><br><span class="line">        <span class="comment">//https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/MIME_types</span></span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 知识点四 ContentType中对于我们来说重要的类型</span></span><br><span class="line">        <span class="comment">//1.通用2进制类型</span></span><br><span class="line">        <span class="comment">//application/octet-stream</span></span><br><span class="line">        <span class="comment">//2.通用文本类型</span></span><br><span class="line">        <span class="comment">//text/plain </span></span><br><span class="line">        <span class="comment">//3.键值对参数</span></span><br><span class="line">        <span class="comment">//application/x-www-form-urlencoded</span></span><br><span class="line">        <span class="comment">//4.复合类型（传递的信息有多种类型组成,比如有键值对参数,有文件信息等等,上传资源服务器时需要用该类型）</span></span><br><span class="line">        <span class="comment">//multipart/form-data</span></span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 总结</span></span><br><span class="line">        <span class="comment">//这节课的重点知识点是</span></span><br><span class="line">        <span class="comment">//1.Get和Post的区别</span></span><br><span class="line">        <span class="comment">//2.ContentType的重要类型</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//注意：</span></span><br><span class="line">        <span class="comment">//HTTP通讯中</span></span><br><span class="line">        <span class="comment">//客户端发送给服务端的Get和Post请求都需要服务端和客户端约定一些规则进行处理</span></span><br><span class="line">        <span class="comment">//比如传递的参数的含义，数据如何处理等等，都是需要前后端程序制定对应规则来进行处理的</span></span><br><span class="line">        <span class="comment">//只是我们目前没有后端开发的HTTP服务器，所以我们传递过去的参数和数据没有得到对应处理</span></span><br><span class="line">        <span class="comment">//我们目前只针对HTTP资源服务器上传下载数据进行学习</span></span><br><span class="line">        <span class="comment">//他们的通讯原理是一致的，都是通过HTTP通讯交换数据</span></span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update is called once per frame</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="上传文件"><a href="#上传文件" class="headerlink" title="上传文件"></a>上传文件</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.Events;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HttpMgr</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> HttpMgr instance = <span class="keyword">new</span> HttpMgr();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HttpMgr Instance =&gt; instance;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> HTTP_PATH = <span class="string">&quot;http://192.168.50.109:8000/Http_Server/&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> USER_NAME = <span class="string">&quot;MrTang3&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> PASS_WORD = <span class="string">&quot;123123&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 上传文件</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;fileName&quot;&gt;</span>传到远端服务器上的文件名<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;loacalFilePath&quot;&gt;</span>本地的文件路径<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;action&quot;&gt;</span>上传结束后的回调函数<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> <span class="keyword">void</span> <span class="title">UpLoadFile</span>(<span class="params"><span class="built_in">string</span> fileName, <span class="built_in">string</span> loacalFilePath, UnityAction&lt;HttpStatusCode&gt; action</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        HttpStatusCode result = HttpStatusCode.BadRequest;</span><br><span class="line">        <span class="keyword">await</span> Task.Run(() =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                HttpWebRequest req = HttpWebRequest.Create(HTTP_PATH) <span class="keyword">as</span> HttpWebRequest;</span><br><span class="line">                req.Method = WebRequestMethods.Http.Post;</span><br><span class="line">                req.ContentType = <span class="string">&quot;multipart/form-data;boundary=MrTang&quot;</span>;</span><br><span class="line">                req.Timeout = <span class="number">500000</span>;</span><br><span class="line">                req.Credentials = <span class="keyword">new</span> NetworkCredential(USER_NAME, PASS_WORD);</span><br><span class="line">                req.PreAuthenticate = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//拼接字符串 头部</span></span><br><span class="line">                <span class="built_in">string</span> head = <span class="string">&quot;--MrTang\r\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;Content-Disposition:form-data;name=\&quot;file\&quot;;filename=\&quot;&#123;0&#125;\&quot;\r\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;Content-Type:application/octet-stream\r\n\r\n&quot;</span>;</span><br><span class="line">                <span class="comment">//替换文件名</span></span><br><span class="line">                head = <span class="built_in">string</span>.Format(head, fileName);</span><br><span class="line">                <span class="built_in">byte</span>[] headBytes = Encoding.UTF8.GetBytes(head);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//尾部的边界字符串</span></span><br><span class="line">                <span class="built_in">byte</span>[] endBytes = Encoding.UTF8.GetBytes(<span class="string">&quot;\r\n--MrTang--\r\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">using</span> (FileStream localStream = File.OpenRead(loacalFilePath))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//设置长度</span></span><br><span class="line">                    req.ContentLength = headBytes.Length + localStream.Length + endBytes.Length;</span><br><span class="line">                    <span class="comment">//写入流</span></span><br><span class="line">                    Stream upLoadStream = req.GetRequestStream();</span><br><span class="line">                    <span class="comment">//写入头部</span></span><br><span class="line">                    upLoadStream.Write(headBytes, <span class="number">0</span>, headBytes.Length);</span><br><span class="line">                    <span class="comment">//写入上传文件</span></span><br><span class="line">                    <span class="built_in">byte</span>[] bytes = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">4096</span>];</span><br><span class="line">                    <span class="built_in">int</span> contentLenght = localStream.Read(bytes, <span class="number">0</span>, bytes.Length);</span><br><span class="line">                    <span class="keyword">while</span> (contentLenght != <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        upLoadStream.Write(bytes, <span class="number">0</span>, contentLenght);</span><br><span class="line">                        contentLenght = localStream.Read(bytes, <span class="number">0</span>, bytes.Length);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//写入尾部</span></span><br><span class="line">                    upLoadStream.Write(endBytes, <span class="number">0</span>, endBytes.Length);</span><br><span class="line"></span><br><span class="line">                    upLoadStream.Close();</span><br><span class="line">                    loacalFilePath.Clone();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                HttpWebResponse res = req.GetResponse() <span class="keyword">as</span> HttpWebResponse;</span><br><span class="line">                <span class="comment">//让外部去处理结果 </span></span><br><span class="line">                result = res.StatusCode;</span><br><span class="line">                res.Close();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (WebException w)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.Log(<span class="string">&quot;上传出错&quot;</span> + w.Status + w.Message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        action?.Invoke(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="WWW类"><a href="#WWW类" class="headerlink" title="WWW类"></a>WWW类</h1><h2 id="加载资源"><a href="#加载资源" class="headerlink" title="加载资源"></a>加载资源</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Lesson28</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> RawImage image;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start is called before the first frame update</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 知识点一 WWW类的作用</span></span><br><span class="line">        <span class="comment">//WWW是Unity提供给我们简单的访问网页的类</span></span><br><span class="line">        <span class="comment">//我们可以通过该类下载和上传一些数据</span></span><br><span class="line">        <span class="comment">//在使用http协议时，默认的请求类型是Get，如果想要Post上传，需要配合下节课学习的WWWFrom类使用</span></span><br><span class="line">        <span class="comment">//它主要支持的协议</span></span><br><span class="line">        <span class="comment">//1.http://和https:// 超文本传输协议</span></span><br><span class="line">        <span class="comment">//2.ftp:// 文件传输协议（但仅限于匿名下载）</span></span><br><span class="line">        <span class="comment">//3.file:// 本地文件传输协议，可以使用该协议异步加载本地文件（PC、IOS、Android都支持）</span></span><br><span class="line">        <span class="comment">//我们本节课主要学习利用WWW来进行数据的下载或加载</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//注意：</span></span><br><span class="line">        <span class="comment">//1.该类一般配合协同程序使用</span></span><br><span class="line">        <span class="comment">//2.该类在较新Unity版本中会提示过时，但是仍可以使用，新版本将其功能整合进了UnityWebRequest类（之后讲解）</span></span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 知识点二 WWW类的常用方法和变量</span></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 常用方法</span></span><br><span class="line">        <span class="comment">//1.WWW：构造函数，用于创建一个WWW请求</span></span><br><span class="line">        WWW www = <span class="keyword">new</span> WWW(<span class="string">&quot;http://192.168.50.109:8000/Http_Server/实战就业路线.jpg&quot;</span>);</span><br><span class="line">        <span class="comment">//2.GetAudioClip：从下载数据返回一个音效切片AudioClip对象</span></span><br><span class="line">        <span class="comment">//www.GetAudioClip()</span></span><br><span class="line">        <span class="comment">//3.LoadImageIntoTexture：用下载数据中的图像来替换现有的一个Texture2D对象</span></span><br><span class="line">        <span class="comment">//Texture2D tex = new Texture2D(100, 100);</span></span><br><span class="line">        <span class="comment">//www.LoadImageIntoTexture(tex);</span></span><br><span class="line">        <span class="comment">//4.LoadFromCacheOrDownload：从缓存加载AB包对象，如果该包不在缓存则自动下载存储到缓存中，以便以后直接从本地缓存中加载</span></span><br><span class="line">        <span class="comment">//WWW.LoadFromCacheOrDownload(&quot;http://192.168.50.109:8000/Http_Server/test.assetbundle&quot;, 1);</span></span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 常用变量</span></span><br><span class="line">        <span class="comment">//1.assetBundle：如果加载的数据是AB包，可以通过该变量直接获取加载结果</span></span><br><span class="line">        <span class="comment">//www.assetBundle</span></span><br><span class="line">        <span class="comment">//2.audioClip：如果加载的数据是音效切片文件，可以通过该变量直接获取加载结果</span></span><br><span class="line">        <span class="comment">//www.GetAudioClip</span></span><br><span class="line">        <span class="comment">//3.bytes：以字节数组的形式获取加载到的内容</span></span><br><span class="line">        <span class="comment">//www.bytes</span></span><br><span class="line">        <span class="comment">//4.bytesDownloaded：过去已下载的字节数</span></span><br><span class="line">        <span class="comment">//www.bytesDownloaded</span></span><br><span class="line">        <span class="comment">//5.error：返回一个错误消息，如果下载期间出现错误，可以通过它获取错误信息</span></span><br><span class="line">        <span class="comment">//www.error != null</span></span><br><span class="line">        <span class="comment">//6.isDone：判断下载是否已经完成</span></span><br><span class="line">        <span class="comment">//www.isDone</span></span><br><span class="line">        <span class="comment">//7.movie：如果下载的视频，可以获取一个MovieTexture类型结果</span></span><br><span class="line">        <span class="comment">//www.GetMovieTexture()</span></span><br><span class="line">        <span class="comment">//8.progress:下载进度</span></span><br><span class="line">        <span class="comment">//www.progress</span></span><br><span class="line">        <span class="comment">//9.text：如果下载的数据是字符串，以字符串的形式返回内容</span></span><br><span class="line">        <span class="comment">//www.text</span></span><br><span class="line">        <span class="comment">//10.texture：如果下载的数据是图片，以Texture2D的形式返回加载结果</span></span><br><span class="line">        <span class="comment">//www.texture</span></span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 知识点三 利用WWW类来异步下载或加载文件</span></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 1.下载HTTP服务器上的内容</span></span><br><span class="line">        <span class="comment">//StartCoroutine(DownLoadHttp());</span></span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 2.下载FTP服务器上的内容（FTP服务器一定要支持匿名账户）</span></span><br><span class="line">        <span class="comment">//StartCoroutine(DownLoadFtp());</span></span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 3.本地内容加载（一般移动平台加载数据都会使用该方式）</span></span><br><span class="line">        StartCoroutine(DownLoadLocal());</span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 总结</span></span><br><span class="line">        <span class="comment">//Unity中的WWW类比使用C#中的Http相关类更加的方便</span></span><br><span class="line">        <span class="comment">//建议大家使用Unity当中为我们封装好的类来处理下载、加载相关逻辑</span></span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">IEnumerator <span class="title">DownLoadHttp</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//1.创建WWW对象</span></span><br><span class="line">        WWW www = <span class="keyword">new</span> WWW(<span class="string">&quot;https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fi2.hdslb.com%2Fbfs%2Farchive%2F8cc2b9a7868b266800f98d42fc5d257021e75103.jpg&amp;refer=http%3A%2F%2Fi2.hdslb.com&amp;app=2002&amp;size=f9999,10000&amp;q=a80&amp;n=0&amp;g=0n&amp;fmt=auto?sec=1654745686&amp;t=b7691b6e546367610e4331039d1a10ec&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2.就是等待加载结束</span></span><br><span class="line">        <span class="keyword">while</span> (!www.isDone)</span><br><span class="line">        &#123;</span><br><span class="line">            print(www.bytesDownloaded);</span><br><span class="line">            print(www.progress);</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        print(www.bytesDownloaded);</span><br><span class="line">        print(www.progress);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.使用加载结束后的资源</span></span><br><span class="line">        <span class="keyword">if</span> (www.error == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            image.texture = www.texture;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            print(www.error);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">IEnumerator <span class="title">DownLoadFtp</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//1.创建WWW对象</span></span><br><span class="line">        WWW www = <span class="keyword">new</span> WWW(<span class="string">&quot;ftp://127.0.0.1/实战就业路线.jpg&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2.就是等待加载结束</span></span><br><span class="line">        <span class="keyword">while</span> (!www.isDone)</span><br><span class="line">        &#123;</span><br><span class="line">            print(www.bytesDownloaded);</span><br><span class="line">            print(www.progress);</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        print(www.bytesDownloaded);</span><br><span class="line">        print(www.progress);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.使用加载结束后的资源</span></span><br><span class="line">        <span class="keyword">if</span> (www.error == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            image.texture = www.texture;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            print(www.error);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">IEnumerator <span class="title">DownLoadLocal</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//1.创建WWW对象</span></span><br><span class="line">        WWW www = <span class="keyword">new</span> WWW(<span class="string">&quot;file://&quot;</span> + Application.streamingAssetsPath + <span class="string">&quot;/test.png&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2.就是等待加载结束</span></span><br><span class="line">        <span class="keyword">while</span> (!www.isDone)</span><br><span class="line">        &#123;</span><br><span class="line">            print(www.bytesDownloaded);</span><br><span class="line">            print(www.progress);</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        print(www.bytesDownloaded);</span><br><span class="line">        print(www.progress);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.使用加载结束后的资源</span></span><br><span class="line">        <span class="keyword">if</span> (www.error == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            image.texture = www.texture;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            print(www.error);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update is called once per frame</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="加载资源类"><a href="#加载资源类" class="headerlink" title="加载资源类"></a>加载资源类</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.Events;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NetWWWMgr</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> NetWWWMgr instance;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> NetWWWMgr Instance =&gt; instance;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        instance = <span class="keyword">this</span>;</span><br><span class="line">        DontDestroyOnLoad(<span class="keyword">this</span>.gameObject);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 提供给外部加载资源用的方法</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>资源的类型<span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;path&quot;&gt;</span>资源的路径 http ftp file都支持<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;action&quot;&gt;</span>加载结束后的回调函数 因为WWW是通过结合协同程序异步加载的 所以不能马上获取结果 需要回调获取<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">LoadRes</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">string</span> path, UnityAction&lt;T&gt; action</span>) <span class="keyword">where</span> T : <span class="keyword">class</span></span></span><br><span class="line">    &#123;</span><br><span class="line">        StartCoroutine(LoadResAsync&lt;T&gt;(path, action));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> IEnumerator <span class="title">LoadResAsync</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">string</span> path, UnityAction&lt;T&gt; action</span>) <span class="keyword">where</span> T : <span class="keyword">class</span></span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//声明www对象 用于下载或加载</span></span><br><span class="line">        WWW www = <span class="keyword">new</span> WWW(path);</span><br><span class="line">        <span class="comment">//等待下载或者加载结束（异步）</span></span><br><span class="line">        <span class="keyword">yield</span> <span class="keyword">return</span> www;</span><br><span class="line">        <span class="comment">//如果没有错误 证明加载成功</span></span><br><span class="line">        <span class="keyword">if</span> (www.error == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//根据T泛型的类型  决定使用哪种类型的资源 传递给外部</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">typeof</span>(T) == <span class="keyword">typeof</span>(AssetBundle))</span><br><span class="line">            &#123;</span><br><span class="line">                action?.Invoke(www.assetBundle <span class="keyword">as</span> T);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span>(T) == <span class="keyword">typeof</span>(Texture))</span><br><span class="line">            &#123;</span><br><span class="line">                action?.Invoke(www.texture <span class="keyword">as</span> T);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span>(T) == <span class="keyword">typeof</span>(AudioClip))</span><br><span class="line">            &#123;</span><br><span class="line">                action?.Invoke(www.GetAudioClip() <span class="keyword">as</span> T);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span>(T) == <span class="keyword">typeof</span>(<span class="built_in">string</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                action?.Invoke(www.text <span class="keyword">as</span> T);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span>(T) == <span class="keyword">typeof</span>(<span class="built_in">byte</span>[]))</span><br><span class="line">            &#123;</span><br><span class="line">                action?.Invoke(www.bytes <span class="keyword">as</span> T);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//自定义一些类型 可能需要将bytes 转换成对应的类型来使用</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果错误 就提示别人</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">&quot;www加载资源出错&quot;</span> + www.error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Lesson28E_Test</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> RawImage image;</span><br><span class="line">    <span class="comment">// Start is called before the first frame update</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//只要保证一运行时 进行该判断 进行动态创建</span></span><br><span class="line">        <span class="keyword">if</span>(NetWWWMgr.Instance == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            GameObject obj = <span class="keyword">new</span> GameObject(<span class="string">&quot;WWW&quot;</span>);</span><br><span class="line">            obj.AddComponent&lt;NetWWWMgr&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//在任何地方使用NetWWWMgr都没有问题</span></span><br><span class="line"></span><br><span class="line">        NetWWWMgr.Instance.LoadRes&lt;Texture&gt;(<span class="string">&quot;http://192.168.50.109:8000/Http_Server/实战就业路线.jpg&quot;</span>, (obj) =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//使用加载结束的资源</span></span><br><span class="line">            image.texture = obj;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        NetWWWMgr.Instance.LoadRes&lt;<span class="built_in">byte</span>[]&gt;(<span class="string">&quot;http://192.168.50.109:8000/Http_Server/实战就业路线.jpg&quot;</span>, (obj) =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//使用加载结束的资源</span></span><br><span class="line">            <span class="comment">//把得到的字节数组存储到本地</span></span><br><span class="line">            print(Application.persistentDataPath);</span><br><span class="line">            File.WriteAllBytes(Application.persistentDataPath + <span class="string">&quot;/www图片.jpg&quot;</span>, obj);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        NetWWWMgr.Instance.LoadRes&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;http://192.168.50.109:8000/Http_Server/test.txt&quot;</span>, (str) =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            print(str);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update is called once per frame</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="WWWFrom"><a href="#WWWFrom" class="headerlink" title="WWWFrom"></a>WWWFrom</h1><h2 id="上传资源"><a href="#上传资源" class="headerlink" title="上传资源"></a>上传资源</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Lesson29</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Start is called before the first frame update</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 知识点一 WWWFrom类的作用</span></span><br><span class="line">        <span class="comment">//上节课学习了使用WWW类来下载数据</span></span><br><span class="line">        <span class="comment">//如果想要使用WWW上传数据时，就需要配合WWWFrom类进行使用了</span></span><br><span class="line">        <span class="comment">//而WWWFrom主要就是用于集成数据的，我们可以设置上传的参数或者2进制数据</span></span><br><span class="line">        <span class="comment">//当结合WWWFrom上传数据时</span></span><br><span class="line">        <span class="comment">//它主要用到的请求类型是Post</span></span><br><span class="line">        <span class="comment">//它使用Http协议进行上传处理</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//注意：</span></span><br><span class="line">        <span class="comment">//使用WWW结合WWWFrom上传数据一般需要配合后端程序制定上传规则</span></span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 知识点二 WWWFrom类的常用方法和变量</span></span><br><span class="line">        <span class="comment">//该类当中我们主要就使用方法，相关变量很少使用，我们主要就着重讲解方法</span></span><br><span class="line">        <span class="comment">//1.WWWForm：构造函数</span></span><br><span class="line">        WWWForm data = <span class="keyword">new</span> WWWForm();</span><br><span class="line">        <span class="comment">//2.AddBinaryData：添加二进制数据</span></span><br><span class="line">        <span class="comment">//data.AddBinaryData()</span></span><br><span class="line">        <span class="comment">//3.AddField：添加字段</span></span><br><span class="line">        <span class="comment">//data.AddField()</span></span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 知识点三 WWW结合WWWFrom对象来异步上传数据</span></span><br><span class="line">        StartCoroutine(UpLoadData());</span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 总结</span></span><br><span class="line">        <span class="comment">//WWW结合WWWFrom上传数据</span></span><br><span class="line">        <span class="comment">//需要配合后端服务器来指定上传规则</span></span><br><span class="line">        <span class="comment">//也就是说我们上传的数据，后端需要知道收到数据后应该如何处理</span></span><br><span class="line">        <span class="comment">//通过这种方式我们没办法像C#类当中完成文件的上传</span></span><br><span class="line">        <span class="comment">//但是该方式非常适合用于制作短连接游戏的前端网络层</span></span><br><span class="line">        <span class="comment">//我们可以对WWW进行二次封装，专门用于上传自定义消息给对应的Web服务器</span></span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">IEnumerator <span class="title">UpLoadData</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        WWWForm data = <span class="keyword">new</span> WWWForm();</span><br><span class="line">        <span class="comment">//上传的数据 对应的后端程序 必须要有处理的规则 才能生效</span></span><br><span class="line">        data.AddField(<span class="string">&quot;Name&quot;</span>, <span class="string">&quot;MrTang&quot;</span>, Encoding.UTF8);</span><br><span class="line">        data.AddField(<span class="string">&quot;Age&quot;</span>, <span class="number">99</span>);</span><br><span class="line">        data.AddBinaryData(<span class="string">&quot;file&quot;</span>, File.ReadAllBytes(Application.streamingAssetsPath + <span class="string">&quot;/test.png&quot;</span>), <span class="string">&quot;testtest.png&quot;</span>, <span class="string">&quot;application/octet-stream&quot;</span>);</span><br><span class="line"></span><br><span class="line">        WWW www = <span class="keyword">new</span> WWW(<span class="string">&quot;http://192.168.50.109:8000/Http_Server/&quot;</span>, data);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">yield</span> <span class="keyword">return</span> www;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (www.error == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            print(<span class="string">&quot;上传成功&quot;</span>);</span><br><span class="line">            <span class="comment">//www.bytes</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            print(<span class="string">&quot;上传失败&quot;</span> + www.error);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update is called once per frame</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="发送一个自定义信息"><a href="#发送一个自定义信息" class="headerlink" title="发送一个自定义信息"></a>发送一个自定义信息</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> IEnumerator <span class="title">SendMsgAsync</span>&lt;<span class="title">T</span>&gt;(<span class="params">BaseMsg msg, UnityAction&lt;T&gt; action</span>) <span class="keyword">where</span> T : BaseMsg</span></span><br><span class="line">  &#123;</span><br><span class="line">      <span class="comment">//消息发送</span></span><br><span class="line">      WWWForm data = <span class="keyword">new</span> WWWForm();</span><br><span class="line">      <span class="comment">//准备要发送的消息数据</span></span><br><span class="line">      data.AddBinaryData(<span class="string">&quot;Msg&quot;</span>, msg.Writing());</span><br><span class="line"></span><br><span class="line">      WWW www = <span class="keyword">new</span> WWW(HTTP_SERVER_PATH, data);</span><br><span class="line">      <span class="comment">//我们也可以直接传递 2进制字节数组 只要和后端定好规则 怎么传都是可以的</span></span><br><span class="line">      <span class="comment">//WWW www = new WWW(&quot;HTTP_SERVER_PATH&quot;, msg.Writing());</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">//异步等待 发送结束 才会继续执行后面的代码</span></span><br><span class="line">      <span class="keyword">yield</span> <span class="keyword">return</span> www;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//发送完毕过后 收到响应 </span></span><br><span class="line">      <span class="comment">//认为 后端发回来的内容 也是一个继承自BaseMsg类的一个字节数组对象</span></span><br><span class="line">      <span class="keyword">if</span> (www.error == <span class="literal">null</span>)</span><br><span class="line">      &#123;</span><br><span class="line">          <span class="comment">//先解析 ID和消息长度</span></span><br><span class="line">          <span class="built_in">int</span> index = <span class="number">0</span>;</span><br><span class="line">          <span class="built_in">int</span> msgID = BitConverter.ToInt32(www.bytes, index);</span><br><span class="line">          index += <span class="number">4</span>;</span><br><span class="line">          <span class="built_in">int</span> msgLength = BitConverter.ToInt32(www.bytes, index);</span><br><span class="line">          index += <span class="number">4</span>;</span><br><span class="line">          <span class="comment">//反序列化 BaseMsg</span></span><br><span class="line">          BaseMsg baseMsg = <span class="literal">null</span>;</span><br><span class="line">          <span class="keyword">switch</span> (msgID)</span><br><span class="line">          &#123;</span><br><span class="line">              <span class="keyword">case</span> <span class="number">1001</span>:</span><br><span class="line">                  baseMsg = <span class="keyword">new</span> PlayerMsg();</span><br><span class="line">                  baseMsg.Reading(www.bytes, index);</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (baseMsg != <span class="literal">null</span>)</span><br><span class="line">              action?.Invoke(baseMsg <span class="keyword">as</span> T);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">          Debug.LogError(<span class="string">&quot;发消息出问题&quot;</span> + www.error);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>


    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" rel="tag"># 网络编程</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/05/06/UnityShader/" rel="prev" title="UnityShader">
      <i class="fa fa-chevron-left"></i> UnityShader
    </a></div>
      <div class="post-nav-item">
    <a href="/2023/07/14/unity%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B001/" rel="next" title="unity学习笔记01">
      unity学习笔记01 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%86%85%E5%AE%B9"><span class="nav-number">1.</span> <span class="nav-text">内容</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#UDP%E9%80%9A%E4%BF%A1"><span class="nav-number">2.</span> <span class="nav-text">UDP通信</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E9%80%9A%E4%BF%A1%E4%BB%A3%E7%A0%81"><span class="nav-number">2.1.</span> <span class="nav-text">简单通信代码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-number">2.1.1.</span> <span class="nav-text">客户端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="nav-number">2.1.2.</span> <span class="nav-text">服务端</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B1%BB%E5%8C%BA%E5%88%86"><span class="nav-number">2.2.</span> <span class="nav-text">类区分</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF-1"><span class="nav-number">2.2.1.</span> <span class="nav-text">服务端</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ServerSocket"><span class="nav-number">2.2.1.1.</span> <span class="nav-text">ServerSocket</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ClientSocket"><span class="nav-number">2.2.1.2.</span> <span class="nav-text">ClientSocket</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF-1"><span class="nav-number">2.2.2.</span> <span class="nav-text">客户端</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MTU"><span class="nav-number">3.</span> <span class="nav-text">MTU</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#FTP%E5%8D%8F%E8%AE%AE"><span class="nav-number">4.</span> <span class="nav-text">FTP协议</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#FTP%E7%9B%B8%E5%85%B3%E7%B1%BB"><span class="nav-number">4.1.</span> <span class="nav-text">FTP相关类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%80%E5%8D%95FTP%E4%B8%8A%E4%BC%A0"><span class="nav-number">4.2.</span> <span class="nav-text">简单FTP上传</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%82%E6%AD%A5%E4%B8%8A%E4%BC%A0"><span class="nav-number">4.2.1.</span> <span class="nav-text">异步上传</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%82%E6%AD%A5%E4%B8%8B%E8%BD%BD"><span class="nav-number">4.3.</span> <span class="nav-text">异步下载</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#XML%E9%85%8D%E7%BD%AE%E5%8D%8F%E8%AE%AE"><span class="nav-number">5.</span> <span class="nav-text">XML配置协议</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#xml%E6%96%87%E4%BB%B6"><span class="nav-number">5.1.</span> <span class="nav-text">xml文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%A3%E6%9E%90XML%E6%96%87%E4%BB%B6"><span class="nav-number">5.2.</span> <span class="nav-text">解析XML文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%9F%E6%88%90%E6%9E%9A%E4%B8%BE%E7%B1%BB%E5%9E%8B"><span class="nav-number">5.3.</span> <span class="nav-text">生成枚举类型</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Protobuf"><span class="nav-number">6.</span> <span class="nav-text">Protobuf</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%8F%E8%AE%AE%E7%BC%96%E5%86%99%E8%A7%84%E5%88%99"><span class="nav-number">6.1.</span> <span class="nav-text">协议编写规则</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%8F%E8%AE%AE%E7%94%9F%E6%88%90"><span class="nav-number">6.2.</span> <span class="nav-text">协议生成</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%9A%84%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-number">6.3.</span> <span class="nav-text">数据的序列化和反序列化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%98%E5%85%A5%E8%AF%BB%E5%8F%96%E6%96%87%E4%BB%B6%E5%92%8C%E5%86%85%E5%AD%98%E6%B5%81"><span class="nav-number">6.3.1.</span> <span class="nav-text">存入读取文件和内存流</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NetTool%EF%BC%88%E7%9B%B4%E6%8E%A5%E5%BA%8F%E5%88%97%E5%8C%96%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%89"><span class="nav-number">6.3.2.</span> <span class="nav-text">NetTool（直接序列化反序列化）</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86"><span class="nav-number">7.</span> <span class="nav-text">消息处理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%A7%E5%B0%8F%E7%AB%AF%E6%A8%A1%E5%BC%8F"><span class="nav-number">7.1.</span> <span class="nav-text">大小端模式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E5%8A%A0%E5%AF%86"><span class="nav-number">7.2.</span> <span class="nav-text">消息加密</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#HTTP"><span class="nav-number">8.</span> <span class="nav-text">HTTP</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#HTTP%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="nav-number">8.1.</span> <span class="nav-text">HTTP的工作原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HTTP%E7%9A%84%E8%AF%B7%E6%B1%82%E7%B1%BB%E5%9E%8B%E5%92%8C%E5%93%8D%E5%BA%94%E7%8A%B6%E6%80%81%E7%A0%81"><span class="nav-number">8.2.</span> <span class="nav-text">HTTP的请求类型和响应状态码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HTTP%E5%B8%B8%E7%94%A8%E7%B1%BB"><span class="nav-number">8.3.</span> <span class="nav-text">HTTP常用类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HTTP%E4%B8%8B%E8%BD%BD%E6%96%87%E4%BB%B6"><span class="nav-number">8.4.</span> <span class="nav-text">HTTP下载文件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%82%E6%AD%A5%E4%B8%8B%E8%BD%BD-1"><span class="nav-number">8.4.1.</span> <span class="nav-text">异步下载</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Post%E7%9F%A5%E8%AF%86"><span class="nav-number">8.5.</span> <span class="nav-text">Post知识</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6"><span class="nav-number">8.6.</span> <span class="nav-text">上传文件</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WWW%E7%B1%BB"><span class="nav-number">9.</span> <span class="nav-text">WWW类</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8A%A0%E8%BD%BD%E8%B5%84%E6%BA%90"><span class="nav-number">9.1.</span> <span class="nav-text">加载资源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8A%A0%E8%BD%BD%E8%B5%84%E6%BA%90%E7%B1%BB"><span class="nav-number">9.2.</span> <span class="nav-text">加载资源类</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8"><span class="nav-number">9.2.1.</span> <span class="nav-text">使用</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WWWFrom"><span class="nav-number">10.</span> <span class="nav-text">WWWFrom</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8A%E4%BC%A0%E8%B5%84%E6%BA%90"><span class="nav-number">10.1.</span> <span class="nav-text">上传资源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%91%E9%80%81%E4%B8%80%E4%B8%AA%E8%87%AA%E5%AE%9A%E4%B9%89%E4%BF%A1%E6%81%AF"><span class="nav-number">10.2.</span> <span class="nav-text">发送一个自定义信息</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="心梦"
      src="/images/ailulu.jpg">
  <p class="site-author-name" itemprop="name">心梦</p>
  <div class="site-description" itemprop="description">heart_dream</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">70</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/heartdream520" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;heartdream520" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.acwing.com/user/myspace/index/60784/" title="Acwing → https:&#x2F;&#x2F;www.acwing.com&#x2F;user&#x2F;myspace&#x2F;index&#x2F;60784&#x2F;" rel="noopener" target="_blank"><i class="fab fa-Acwing fa-fw"></i>Acwing</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://codeforces.com/profile/Heart_dream" title="Codeforces → https:&#x2F;&#x2F;codeforces.com&#x2F;profile&#x2F;Heart_dream" rel="noopener" target="_blank"><i class="fab fa-codeforces fa-fw"></i>Codeforces</a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">心梦</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">419k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">6:21</span>
</div>



        








      </div>
    </footer>
  </div>

  
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
